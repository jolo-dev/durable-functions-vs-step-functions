import{DynamoDBClient as d,PutItemCommand as l,UpdateItemCommand as S,GetItemCommand as g}from"@aws-sdk/client-dynamodb";var i=new d({}),c=async o=>{console.log("Signal handler triggered:",JSON.stringify(o,null,2));try{let s=typeof o.body=="string"?JSON.parse(o.body):o.body,{requestId:e,code:n,taskToken:r}=s;if(!e||!n)return{statusCode:400,body:JSON.stringify({error:"Missing requestId"})};if(!r)try{let t=await i.send(new g({TableName:process.env.TABLE_NAME,Key:{id:{S:e},sort:{S:"taskToken"}}}));t.Item?.taskToken?.S&&(r=t.Item.taskToken.S)}catch(t){console.warn("Failed to lookup taskToken:",t)}if(r){if(await i.send(new S({TableName:process.env.TABLE_NAME,Key:{id:{S:e},sort:{S:"0"}},UpdateExpression:"SET #signal = :signal",ExpressionAttributeNames:{"#signal":"signal"},ExpressionAttributeValues:{":signal":{S:JSON.stringify({code:n})}}})),n!==void 0){let{SFNClient:t,SendTaskSuccessCommand:a}=await import("@aws-sdk/client-sfn");await new t({}).send(new a({taskToken:r,output:JSON.stringify({code:n})}))}return{statusCode:200,body:JSON.stringify({message:"Signal sent to Step Functions",requestId:e,code:n})}}return await i.send(new l({TableName:process.env.TABLE_NAME,Item:{id:{S:`signal-${e}`},sort:{S:"0"},requestId:{S:e},code:{S:n},timestamp:{S:new Date().toISOString()}}})),{statusCode:200,body:JSON.stringify({message:"Signal stored for Durable Functions",requestId:e,code:n})}}catch(s){return console.error("Error in signal handler:",s),{statusCode:500,body:JSON.stringify({error:"Failed to process signal",details:s instanceof Error?s.message:"Unknown error"})}}};export{c as handler};

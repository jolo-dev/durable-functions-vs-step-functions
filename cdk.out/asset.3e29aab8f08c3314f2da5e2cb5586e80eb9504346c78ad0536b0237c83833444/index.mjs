import{DynamoDBClient as c,GetItemCommand as l,DeleteItemCommand as m}from"@aws-sdk/client-dynamodb";import{LambdaClient as y,InvokeCommand as f}from"@aws-sdk/client-lambda";import{SFNClient as u,SendTaskSuccessCommand as b}from"@aws-sdk/client-sfn";var p=new u({}),i=new c({}),N=async e=>{console.log(e);let r=typeof e.body=="string"?JSON.parse(e.body):e.body,{email:t,token:o,code:n}=r;if(!o||!n)return{statusCode:400,body:JSON.stringify({error:"token and code required"})};let a=await i.send(new l({TableName:process.env.TABLE_NAME,Key:{id:{S:t},sort:{S:n}}}));if(console.log("taskToken GetItemCommand",a),a.Item?.sort?.S!==n)return{statusCode:400,body:JSON.stringify({error:"Invalid verification code"})};if(e.body.durable)await new y().send(new f({FunctionName:"durable-handler",InvocationType:"Event",Payload:JSON.stringify({operation:"SendDurableExecutionCallbackSuccess",callbackId:o,result:JSON.stringify({verification:"ok"})})}));else{let s=new b({taskToken:o,output:JSON.stringify({verification:"ok"})}),d=await p.send(s);console.log("taskToken result",d)}return await i.send(new m({TableName:process.env.TABLE_NAME,Key:{id:{S:t}}})),{statusCode:200,body:JSON.stringify({message:"Verification accepted"})}};export{N as handler};

import{DynamoDBClient as l,GetItemCommand as c,UpdateItemCommand as u}from"@aws-sdk/client-dynamodb";var r=new l({}),d=900,a=async(n,e,t=d)=>{let o=Date.now();for(;Date.now()-o<t*1e3;){let s=await r.send(new c({TableName:process.env.TABLE_NAME,Key:{email:{S:n},code:{N:"0"}}}));if(s.Item&&s.Item.signal?.S)return{received:!0,value:JSON.parse(s.Item.signal.S)};await new Promise(m=>setTimeout(m,2e3))}return{received:!1}};var i=async(n,e)=>{await r.send(new u({TableName:process.env.TABLE_NAME,Key:{email:{S:n},code:{N:"0"}},UpdateExpression:"SET taskToken = :token",ExpressionAttributeValues:{":token":{S:e}}}))};import{SFNClient as p}from"@aws-sdk/client-sfn";var y=new p({}),E=async n=>{console.log("Wait for signal handler triggered:",JSON.stringify(n,null,2));let{requestId:e,taskToken:t}=n;if(!e||!t)throw new Error("Missing requestId or taskToken");await i(e,t);let o=await a(e,t,900);if(o.received)return{statusCode:200,requestId:e,signalReceived:!0,result:o.value};throw new Error("Signal timeout - no signal received within 15 minutes")};export{E as handler};

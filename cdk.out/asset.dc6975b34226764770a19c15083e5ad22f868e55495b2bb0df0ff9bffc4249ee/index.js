"use strict";var k=Object.create;var d=Object.defineProperty;var y=Object.getOwnPropertyDescriptor;var C=Object.getOwnPropertyNames;var S=Object.getPrototypeOf,g=Object.prototype.hasOwnProperty;var p=(e,o)=>{for(var n in o)d(e,n,{get:o[n],enumerable:!0})},m=(e,o,n,a)=>{if(o&&typeof o=="object"||typeof o=="function")for(let t of C(o))!g.call(e,t)&&t!==n&&d(e,t,{get:()=>o[t],enumerable:!(a=y(o,t))||a.enumerable});return e};var w=(e,o,n)=>(n=e!=null?k(S(e)):{},m(o||!e||!e.__esModule?d(n,"default",{value:e,enumerable:!0}):n,e)),N=e=>m(d({},"__esModule",{value:!0}),e);var I={};p(I,{handler:()=>T});module.exports=N(I);var s=require("@aws-sdk/client-dynamodb"),f=require("@aws-sdk/client-lambda"),i=require("@aws-sdk/client-sfn"),u=new i.SFNClient({}),b=new s.DynamoDBClient({}),T=async e=>{console.log(e);let o=typeof e.body=="string"?JSON.parse(e.body):e.body,{email:n,token:a,code:t}=o;if(!a||!t)return{statusCode:400,body:JSON.stringify({error:"token and code required"})};let l=await b.send(new s.GetItemCommand({TableName:process.env.TABLE_NAME,Key:{id:{S:n},sort:{S:t}}}));if(console.log("taskToken GetItemCommand",l),l.Item?.sort?.S!==t)return e.body.durable||await u.send(new i.SendTaskFailureCommand({taskToken:a,cause:"Invalid verification code"})),{statusCode:400,body:JSON.stringify({error:"Invalid verification code"})};if(o.durable){console.log("Is a durable handler invocation");let r=new f.LambdaClient,c=new(await import("@aws-sdk/client-lambda")).SendDurableExecutionCallbackSuccessCommand({CallbackId:a,Result:JSON.stringify({verification:"ok"})});await r.send(c)}else{let r=new i.SendTaskSuccessCommand({taskToken:a,output:JSON.stringify({verification:"ok"})}),c=await u.send(r);console.log("taskToken result",c)}return await b.send(new s.DeleteItemCommand({TableName:process.env.TABLE_NAME,Key:{id:{S:n}}})),{statusCode:200,body:JSON.stringify({message:"Verification accepted"})}};0&&(module.exports={handler});

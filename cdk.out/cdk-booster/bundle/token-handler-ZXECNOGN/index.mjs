"use strict";var r=Object.defineProperty;var f=Object.getOwnPropertyDescriptor;var y=Object.getOwnPropertyNames;var k=Object.prototype.hasOwnProperty;var C=(e,o)=>{for(var t in o)r(e,t,{get:o[t],enumerable:!0})},S=(e,o,t,a)=>{if(o&&typeof o=="object"||typeof o=="function")for(let n of y(o))!k.call(e,n)&&n!==t&&r(e,n,{get:()=>o[n],enumerable:!(a=f(o,n))||a.enumerable});return e};var g=e=>S(r({},"__esModule",{value:!0}),e);var w={};C(w,{handler:()=>p});module.exports=g(w);var s=require("@aws-sdk/client-dynamodb"),d=require("@aws-sdk/client-lambda"),i=require("@aws-sdk/client-sfn"),m=new i.SFNClient({}),u=new s.DynamoDBClient({}),p=async e=>{console.log(e);let o=typeof e.body=="string"?JSON.parse(e.body):e.body,{email:t,token:a,code:n}=o;if(!a||!n)return{statusCode:400,body:JSON.stringify({error:"token and code required"})};let c=await u.send(new s.GetItemCommand({TableName:process.env.TABLE_NAME,Key:{id:{S:t},sort:{S:n}}}));if(console.log("taskToken GetItemCommand",c),c.Item?.sort?.S!==n)return e.body.durable||await m.send(new i.SendTaskFailureCommand({taskToken:a,cause:"Invalid verification code"})),{statusCode:400,body:JSON.stringify({error:"Invalid verification code"})};if(o.durable)console.log("Is a durable handler invocation"),await new d.LambdaClient().send(new d.SendDurableExecutionCallbackSuccessCommand({CallbackId:a,Result:JSON.stringify({verification:"ok"})}));else{let l=new i.SendTaskSuccessCommand({taskToken:a,output:JSON.stringify({verification:"ok"})}),b=await m.send(l);console.log("taskToken result",b)}return await u.send(new s.DeleteItemCommand({TableName:process.env.TABLE_NAME,Key:{id:{S:t}}})),{statusCode:200,body:JSON.stringify({message:"Verification accepted"})}};0&&(module.exports={handler});

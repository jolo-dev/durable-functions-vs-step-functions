"use strict";var Ue=Object.create;var V=Object.defineProperty;var ve=Object.getOwnPropertyDescriptor;var We=Object.getOwnPropertyNames;var $e=Object.getPrototypeOf,He=Object.prototype.hasOwnProperty;var qe=(r,e)=>{for(var t in e)V(r,t,{get:e[t],enumerable:!0})},Ae=(r,e,t,n)=>{if(e&&typeof e=="object"||typeof e=="function")for(let a of We(e))!He.call(r,a)&&a!==t&&V(r,a,{get:()=>e[a],enumerable:!(n=ve(e,a))||n.enumerable});return r};var ze=(r,e,t)=>(t=r!=null?Ue($e(r)):{},Ae(e||!r||!r.__esModule?V(t,"default",{value:r,enumerable:!0}):t,r)),Ge=r=>Ae(V({},"__esModule",{value:!0}),r);var kt={};qe(kt,{handler:()=>It});module.exports=Ge(kt);var J=require("@aws-sdk/client-ses"),Q=require("@aws-sdk/client-dynamodb"),Be=new J.SESClient({}),Ke=new Q.DynamoDBClient({}),be=async r=>{console.log("send-email request",r);let{email:e,taskToken:t}=r;if(!e)throw new Error("Missing required fields: email");let n=new Date().toISOString(),a="Demo: Your Verification Code",i=Math.floor(1e5+Math.random()*9e5).toString(),o=`Here is your Code: ${i}`,l=`
    <html>
      <body style="font-family: Arial, sans-serif; text-align: center;">
        <div style="max-width: 600px; margin: 20px auto; padding: 20px; border: 1px solid #ddd; border-radius: 8px;">
          <h2 style="color: #333;">Verification Required</h2>
          <p>Thank you for using our service. Please use the following code to continue:</p>
          <div style="background-color: #f5f5f5; padding: 15px; border-radius: 4px; margin: 20px 0;">
            <p style="font-size: 24px; font-weight: bold; color: #007bff; margin: 0;">{ token: ${t}, email: ${e}, code: '${i}' }</p>
          </div>
          <p style="font-size: 12px; color: #777;">This code is valid for 15 minutes.</p>
        </div>
      </body>
    </html>
  `;await Ke.send(new Q.PutItemCommand({TableName:process.env.TABLE_NAME,Item:{id:{S:e},sort:{S:i},status:{S:"pending"},timestamp:{S:n}}}));let u=new J.SendEmailCommand({Source:process.env.SENDER_EMAIL,Destination:{ToAddresses:[e]},Message:{Subject:{Data:a},Body:{Text:{Data:o},Html:{Data:l}}}});try{return await Be.send(u),{timestamp:n,taskToken:t,code:i,status:"sent"}}catch(c){throw new Error(`Failed to send email to ${e}: ${c instanceof Error?c.message:"Unknown error"}`)}};var m=require("@aws-sdk/client-lambda"),we=require("events"),Le=require("async_hooks"),Ne=require("crypto"),Pe=require("node:console"),ue=ze(require("node:util"),1),I;(function(r){r.ExecutionMode="ExecutionMode",r.ReplayMode="ReplayMode",r.ReplaySucceededContext="ReplaySucceededContext"})(I||(I={}));var H;(function(r){r.SUCCEEDED="SUCCEEDED",r.FAILED="FAILED",r.PENDING="PENDING"})(H||(H={}));var D;(function(r){r.STEP="Step",r.WAIT="Wait",r.CALLBACK="Callback",r.RUN_IN_CHILD_CONTEXT="RunInChildContext",r.MAP="Map",r.MAP_ITERATION="MapIteration",r.PARALLEL="Parallel",r.PARALLEL_BRANCH="ParallelBranch",r.WAIT_FOR_CALLBACK="WaitForCallback",r.WAIT_FOR_CONDITION="WaitForCondition",r.CHAINED_INVOKE="ChainedInvoke"})(D||(D={}));var _;(function(r){r.INFO="INFO",r.WARN="WARN",r.ERROR="ERROR",r.DEBUG="DEBUG"})(_||(_={}));var B;(function(r){r.AtMostOncePerRetry="AT_MOST_ONCE_PER_RETRY",r.AtLeastOncePerRetry="AT_LEAST_ONCE_PER_RETRY"})(B||(B={}));var v;(function(r){r.NONE="NONE",r.FULL="FULL",r.HALF="HALF"})(v||(v={}));var k;(function(r){r.SUCCEEDED="SUCCEEDED",r.FAILED="FAILED",r.STARTED="STARTED"})(k||(k={}));var x=class{_promise=null;_executor;_isExecuted=!1;constructor(e){this._executor=e}ensureExecution(){return this._promise||(this._isExecuted=!0,this._promise=this._executor()),this._promise}then(e,t){return this.ensureExecution().then(e,t)}catch(e){return this.ensureExecution().catch(e)}finally(e){return this.ensureExecution().finally(e)}get[Symbol.toStringTag](){return"DurablePromise"}get isExecuted(){return this._isExecuted}},S;(function(r){r.EXECUTING="EXECUTING",r.RETRY_WAITING="RETRY_WAITING",r.IDLE_NOT_AWAITED="IDLE_NOT_AWAITED",r.IDLE_AWAITED="IDLE_AWAITED",r.COMPLETED="COMPLETED"})(S||(S={}));function $(r){let e="days"in r?r.days??0:0,t="hours"in r?r.hours??0:0,n="minutes"in r?r.minutes??0:0,a="seconds"in r?r.seconds??0:0;return e*24*60*60+t*60*60+n*60+a}function te(r,e,t){return r.terminationManager.terminate({reason:e.terminationReason,message:`Unrecoverable error in step ${t}: ${e.message}`}),new Promise(()=>{})}var je=r=>{try{let e=new WeakSet;return JSON.stringify(r,(t,n)=>{if(typeof n=="object"&&n!==null){if(e.has(n))return"[Circular]";if(e.add(n),n instanceof Error)return{...n,name:n.name,message:n.message,stack:n.stack}}return n},2)}catch{return"[Unable to stringify]"}},h=(r,e,t)=>{process.env.DURABLE_VERBOSE_MODE==="true"&&console.debug(`${r} ${e}`,t?je(t):"")},Ye={maxAttempts:3,initialDelay:{seconds:5},maxDelay:{minutes:5},backoffRate:2,jitter:v.FULL,retryableErrors:[/.*/],retryableErrorTypes:[]},Xe=(r,e)=>{switch(e){case v.NONE:return r;case v.FULL:return Math.random()*r;case v.HALF:return r/2+Math.random()*(r/2);default:return r}},xe=(r={})=>{let e=r.retryableErrors===void 0&&r.retryableErrorTypes===void 0,t={...Ye,...r,retryableErrors:r.retryableErrors??(e?[/.*/]:[])};return(n,a)=>{if(a>=t.maxAttempts)return{shouldRetry:!1};let i=t.retryableErrors.some(s=>s instanceof RegExp?s.test(n.message):n.message.includes(s)),o=t.retryableErrorTypes.some(s=>n instanceof s);if(!i&&!o)return{shouldRetry:!1};let l=$(t.initialDelay),u=$(t.maxDelay),c=Math.min(l*Math.pow(t.backoffRate,a-1),u),E=Xe(c,t.jitter);return{shouldRetry:!0,delay:{seconds:Math.max(1,Math.round(E))}}}},Ie={default:xe({maxAttempts:6,initialDelay:{seconds:5},maxDelay:{seconds:60},backoffRate:2,jitter:v.FULL}),noRetry:xe({maxAttempts:1})},le=class extends Error{constructor(e,t){super("The step execution process was initiated but failed to reach completion due to an interruption."),this.name="StepInterruptedError"}},L=class extends Error{cause;errorData;stackTrace;constructor(e,t,n){super(e),this.name=this.constructor.name,this.cause=t,this.errorData=n}static fromErrorObject(e){let t=new Error(e.ErrorMessage);switch(t.name=e.ErrorType||"Error",t.stack=e.StackTrace?.join(`
`),e.ErrorType){case"StepError":return new j(e.ErrorMessage||"Step failed",t,e.ErrorData);case"CallbackError":return new O(e.ErrorMessage||"Callback failed",t,e.ErrorData);case"InvokeError":return new z(e.ErrorMessage||"Invoke failed",t,e.ErrorData);case"ChildContextError":return new F(e.ErrorMessage||"Child context failed",t,e.ErrorData);case"WaitForConditionError":return new re(e.ErrorMessage||"Wait for condition failed",t,e.ErrorData);default:return new j(e.ErrorMessage||"Unknown error",t,e.ErrorData)}}toErrorObject(){return{ErrorType:this.errorType,ErrorMessage:this.message,ErrorData:this.errorData,StackTrace:void 0}}},j=class extends L{errorType="StepError";constructor(e,t,n){super(e||"Step failed",t,n)}},O=class extends L{errorType="CallbackError";constructor(e,t,n){super(e||"Callback failed",t,n)}},z=class extends L{errorType="InvokeError";constructor(e,t,n){super(e||"Invoke failed",t,n)}},F=class extends L{errorType="ChildContextError";constructor(e,t,n){super(e||"Child context failed",t,n)}},re=class extends L{errorType="WaitForConditionError";constructor(e,t,n){super(e||"Wait for condition failed",t,n)}},W={serialize:async(r,e)=>r!==void 0?JSON.stringify(r):void 0,deserialize:async(r,e)=>r!==void 0?JSON.parse(r):void 0};var R;(function(r){r.OPERATION_TERMINATED="OPERATION_TERMINATED",r.RETRY_SCHEDULED="RETRY_SCHEDULED",r.RETRY_INTERRUPTED_STEP="RETRY_INTERRUPTED_STEP",r.WAIT_SCHEDULED="WAIT_SCHEDULED",r.CALLBACK_PENDING="CALLBACK_PENDING",r.CHECKPOINT_FAILED="CHECKPOINT_FAILED",r.SERDES_FAILED="SERDES_FAILED",r.CONTEXT_VALIDATION_ERROR="CONTEXT_VALIDATION_ERROR",r.CUSTOM="CUSTOM"})(R||(R={}));var ne=class extends Error{originalError;isUnrecoverable=!0;constructor(e,t){super(e),this.originalError=t,this.name=this.constructor.name,t?.stack&&(this.stack=`${this.stack}
Caused by: ${t.stack}`)}},ae=class extends ne{isUnrecoverableExecution=!0;constructor(e,t){super(`[Unrecoverable Execution] ${e}`,t)}},ie=class extends ne{isUnrecoverableInvocation=!0;constructor(e,t){super(`[Unrecoverable Invocation] ${e}`,t)}};function Ve(r){return r instanceof Error&&"isUnrecoverable"in r&&r.isUnrecoverable===!0}function Je(r){return r instanceof Error&&"isUnrecoverableInvocation"in r&&r.isUnrecoverableInvocation===!0}var de=class extends ie{terminationReason=R.SERDES_FAILED;constructor(e,t){super(e||"Serdes operation failed",t)}};async function se(r,e,t,n,a,i){try{let o={entityId:t,durableExecutionArn:i};return await r.serialize(e,o)}catch(o){let l=`Serialization failed for step ${n?`"${n}" `:""}(${t}): ${o instanceof Error?o.message:"Unknown serialization error"}`;return h("\u{1F4A5}","Serialization failed - terminating execution:",{stepId:t,stepName:n,error:o instanceof Error?o.message:String(o)}),a.terminate({reason:R.SERDES_FAILED,message:l}),new Promise(()=>{})}}async function U(r,e,t,n,a,i){try{let o={entityId:t,durableExecutionArn:i};return await r.deserialize(e,o)}catch(o){let l=`Deserialization failed for step ${n?`"${n}" `:""}(${t}): ${o instanceof Error?o.message:"Unknown deserialization error"}`;return h("\u{1F4A5}","Deserialization failed - terminating execution:",{stepId:t,stepName:n,error:o instanceof Error?o.message:String(o)}),a.terminate({reason:R.SERDES_FAILED,message:l}),new Promise(()=>{})}}var Me=new Le.AsyncLocalStorage,he=()=>Me.getStore(),Y=(r,e,t,n,a)=>Me.run({contextId:r,parentId:e,attempt:n,durableExecutionMode:a},t),M=(r,e,t)=>{let n=r||"root",a=he();if(a&&a.contextId!==n){let i=`Context usage error in "${e}": You are using a parent or sibling context instead of the current child context. Expected context ID: "${a.contextId}", but got: "${r}". When inside runInChildContext(), you must use the child context parameter, not the parent context.`;t.terminate({reason:R.CONTEXT_VALIDATION_ERROR,message:i,error:new Error(i)})}};function Qe(r){return r instanceof Error||r!=null&&typeof r=="object"&&"message"in r&&"name"in r}function P(r,e){return r instanceof L?r.toErrorObject():Qe(r)?{ErrorData:e,ErrorMessage:r.message,ErrorType:r.name,StackTrace:void 0}:{ErrorData:e,ErrorMessage:"Unknown error"}}var K=class extends ae{terminationReason=R.CUSTOM;constructor(e){super(e),this.name="NonDeterministicExecutionError"}},X=(r,e,t,n)=>{if(!(!t||!t.Type)){if(t.Type!==e.type){let a=new K(`Non-deterministic execution detected: Operation type mismatch for step "${r}". Expected type "${t.Type}", but got "${e.type}". This indicates non-deterministic control flow in your workflow code.`);te(n,a,r)}if(t.Name!==e.name){let a=new K(`Non-deterministic execution detected: Operation name mismatch for step "${r}". Expected name "${t.Name??"undefined"}", but got "${e.name??"undefined"}". This indicates non-deterministic control flow in your workflow code.`);te(n,a,r)}if(t.SubType!==e.subType){let a=new K(`Non-deterministic execution detected: Operation subtype mismatch for step "${r}". Expected subtype "${t.SubType}", but got "${e.subType}". This indicates non-deterministic control flow in your workflow code.`);te(n,a,r)}}},Ze=(r,e,t,n,a,i)=>(o,l,u)=>{let c,E,d;typeof o=="string"||o===void 0?(c=o,E=l,d=u):(E=o,d=l);let s=n(),f=d?.semantics||B.AtLeastOncePerRetry,g=d?.serdes||W,p=(async()=>{let C=r.getStepData(s);if(X(s,{type:m.OperationType.STEP,name:c,subType:D.STEP},C,r),C?.Status===m.OperationStatus.SUCCEEDED)return h("\u23ED\uFE0F","Step already completed:",{stepId:s}),e.markOperationState(s,S.COMPLETED,{metadata:{stepId:s,name:c,type:m.OperationType.STEP,subType:D.STEP,parentId:i}}),await U(g,C.StepDetails?.Result,s,c,r.terminationManager,r.durableExecutionArn);if(C?.Status===m.OperationStatus.FAILED)throw e.markOperationState(s,S.COMPLETED,{metadata:{stepId:s,name:c,type:m.OperationType.STEP,subType:D.STEP,parentId:i}}),C.StepDetails?.Error?L.fromErrorObject(C.StepDetails.Error):new j("Unknown error");if(C?.Status===m.OperationStatus.PENDING)return e.markOperationState(s,S.RETRY_WAITING,{metadata:{stepId:s,name:c,type:m.OperationType.STEP,subType:D.STEP,parentId:i},endTimestamp:C.StepDetails?.NextAttemptTimestamp}),(async()=>(await e.waitForRetryTimer(s),C=r.getStepData(s),await b()))();if(C?.Status===m.OperationStatus.STARTED&&f===B.AtMostOncePerRetry){let y=new le(s,c),T=(C.StepDetails?.Attempt||0)+1,w=d?.retryStrategy?.(y,T)??Ie.default(y,T);if(!w.shouldRetry)throw await e.checkpoint(s,{Id:s,ParentId:i,Action:m.OperationAction.FAIL,SubType:D.STEP,Type:m.OperationType.STEP,Error:P(y),Name:c}),e.markOperationState(s,S.COMPLETED),L.fromErrorObject(P(y));return await e.checkpoint(s,{Id:s,ParentId:i,Action:m.OperationAction.RETRY,SubType:D.STEP,Type:m.OperationType.STEP,Error:P(y),Name:c,StepOptions:{NextAttemptDelaySeconds:w.delay?$(w.delay):1}}),e.markOperationState(s,S.RETRY_WAITING,{metadata:{stepId:s,name:c,type:m.OperationType.STEP,subType:D.STEP,parentId:i},endTimestamp:r.getStepData(s)?.StepDetails?.NextAttemptTimestamp}),(async()=>(await e.waitForRetryTimer(s),C=r.getStepData(s),await b()))()}return await b();async function b(){C=r.getStepData(s),C?.Status!==m.OperationStatus.STARTED&&(f===B.AtMostOncePerRetry?await e.checkpoint(s,{Id:s,ParentId:i,Action:m.OperationAction.START,SubType:D.STEP,Type:m.OperationType.STEP,Name:c}):e.checkpoint(s,{Id:s,ParentId:i,Action:m.OperationAction.START,SubType:D.STEP,Type:m.OperationType.STEP,Name:c}));try{C=r.getStepData(s);let y=C?.StepDetails?.Attempt||0,T={logger:a};e.markOperationState(s,S.EXECUTING,{metadata:{stepId:s,name:c,type:m.OperationType.STEP,subType:D.STEP,parentId:i}});let w;w=await Y(s,i,()=>E(T),y+1,I.ExecutionMode);let A=await se(g,w,s,c,r.terminationManager,r.durableExecutionArn);return await e.checkpoint(s,{Id:s,ParentId:i,Action:m.OperationAction.SUCCEED,SubType:D.STEP,Type:m.OperationType.STEP,Payload:A,Name:c}),e.markOperationState(s,S.COMPLETED),await U(g,A,s,c,r.terminationManager,r.durableExecutionArn)}catch(y){if(Ve(y))return te(r,y,c||s);C=r.getStepData(s);let T=(C?.StepDetails?.Attempt||0)+1,w=d?.retryStrategy?.(y instanceof Error?y:new Error("Unknown Error"),T)??Ie.default(y instanceof Error?y:new Error("Unknown Error"),T);if(!w.shouldRetry)throw await e.checkpoint(s,{Id:s,ParentId:i,Action:m.OperationAction.FAIL,SubType:D.STEP,Type:m.OperationType.STEP,Error:P(y),Name:c}),e.markOperationState(s,S.COMPLETED),L.fromErrorObject(P(y));return await e.checkpoint(s,{Id:s,ParentId:i,Action:m.OperationAction.RETRY,SubType:D.STEP,Type:m.OperationType.STEP,Error:P(y),Name:c,StepOptions:{NextAttemptDelaySeconds:w.delay?$(w.delay):1}}),e.markOperationState(s,S.RETRY_WAITING,{metadata:{stepId:s,name:c,type:m.OperationType.STEP,subType:D.STEP,parentId:i},endTimestamp:r.getStepData(s)?.StepDetails?.NextAttemptTimestamp}),await e.waitForRetryTimer(s),await b()}}})();return p.catch(()=>{}),new x(async()=>(e.markOperationAwaited(s),await p))},et=(r,e,t,n,a)=>{function i(o,l,u,c){let E=typeof l=="string",d=E?o:void 0,s=E?l:o,f=E?u:l,g=E?c:u,p=t(),C=!1,b=(async()=>{h("\u{1F517}","Invoke phase 1:",{stepId:p,name:d||s});let y=r.getStepData(p);if(X(p,{type:m.OperationType.CHAINED_INVOKE,name:d,subType:D.CHAINED_INVOKE},y,r),y?.Status===m.OperationStatus.SUCCEEDED){h("\u23ED\uFE0F","Invoke already completed:",{stepId:p}),a?.(),e.markOperationState(p,S.COMPLETED,{metadata:{stepId:p,name:d,type:m.OperationType.CHAINED_INVOKE,subType:D.CHAINED_INVOKE,parentId:n}}),C=!0;return}if(y?.Status===m.OperationStatus.FAILED||y?.Status===m.OperationStatus.TIMED_OUT||y?.Status===m.OperationStatus.STOPPED){h("\u274C","Invoke already failed:",{stepId:p}),e.markOperationState(p,S.COMPLETED,{metadata:{stepId:p,name:d,type:m.OperationType.CHAINED_INVOKE,subType:D.CHAINED_INVOKE,parentId:n}}),C=!0;return}if(!y){let T=await se(g?.payloadSerdes||W,f,p,d,r.terminationManager,r.durableExecutionArn);await e.checkpoint(p,{Id:p,ParentId:n,Action:m.OperationAction.START,SubType:D.CHAINED_INVOKE,Type:m.OperationType.CHAINED_INVOKE,Name:d,Payload:T,ChainedInvokeOptions:{FunctionName:s}})}e.markOperationState(p,S.IDLE_NOT_AWAITED,{metadata:{stepId:p,name:d,type:m.OperationType.CHAINED_INVOKE,subType:D.CHAINED_INVOKE,parentId:n}}),h("\u2705","Invoke phase 1 complete:",{stepId:p})})();return b.catch(()=>{}),new x(async()=>{if(await b,C){let w=r.getStepData(p);if(w?.Status===m.OperationStatus.SUCCEEDED){let N=w.ChainedInvokeDetails;return await U(g?.resultSerdes||W,N?.Result,p,d,r.terminationManager,r.durableExecutionArn)}let A=w?.ChainedInvokeDetails;throw A?.Error?new z(A.Error.ErrorMessage||"Invoke failed",A.Error.ErrorMessage?new Error(A.Error.ErrorMessage):void 0,A.Error.ErrorData):new z("Invoke failed")}h("\u{1F517}","Invoke phase 2:",{stepId:p}),e.markOperationAwaited(p),await e.waitForStatusChange(p);let y=r.getStepData(p);if(y?.Status===m.OperationStatus.SUCCEEDED){h("\u2705","Invoke completed:",{stepId:p}),a?.(),e.markOperationState(p,S.COMPLETED);let w=y.ChainedInvokeDetails;return await U(g?.resultSerdes||W,w?.Result,p,d,r.terminationManager,r.durableExecutionArn)}h("\u274C","Invoke failed:",{stepId:p,status:y?.Status}),e.markOperationState(p,S.COMPLETED);let T=y?.ChainedInvokeDetails;throw T?.Error?new z(T.Error.ErrorMessage||"Invoke failed",T.Error.ErrorMessage?new Error(T.Error.ErrorMessage):void 0,T.Error.ErrorData):new z("Invoke failed")})}return i},ke=256*1024,tt=(r,e)=>{let t=r.getStepData(e);return t?t.Status===m.OperationStatus.SUCCEEDED&&t.ContextDetails?.ReplayChildren?I.ReplaySucceededContext:t.Status===m.OperationStatus.SUCCEEDED||t.Status===m.OperationStatus.FAILED?I.ReplayMode:I.ExecutionMode:I.ExecutionMode},rt=(r,e,t,n,a,i,o)=>(l,u,c)=>{let E,d,s;typeof l=="string"||l===void 0?(E=l,d=u,s=c):(d=l,s=u);let f=n();h("\u{1F504}","Running child context:",{entityId:f,name:E});let g=r.getStepData(f);X(f,{type:m.OperationType.CONTEXT,name:E,subType:s?.subType||D.RUN_IN_CHILD_CONTEXT},g,r);let p,C,b=(async()=>{let y=r.getStepData(f);return y?.Status===m.OperationStatus.SUCCEEDED||y?.Status===m.OperationStatus.FAILED?(e.markAncestorFinished(f),nt(r,t,f,E,d,s,a,i)):at(r,e,t,f,E,d,s,a,i,o)})().then(y=>{p=y}).catch(y=>{C=y});return new x(async()=>{if(await b,C!==void 0)throw C;return p})},nt=async(r,e,t,n,a,i,o,l)=>{let u=i?.serdes||W,c=r.getStepData(t),E=c?.ContextDetails?.Result;if(c?.Status===m.OperationStatus.FAILED)if(c.ContextDetails?.Error){let d=L.fromErrorObject(c.ContextDetails.Error);throw new F(d.message,d)}else throw new F("Child context failed");if(c?.ContextDetails?.ReplayChildren){h("\u{1F504}","ReplayChildren mode: Re-executing child context due to large payload:",{entityId:t,stepName:n});let d=l(r,e,I.ReplaySucceededContext,o(),t,void 0,t);return await Y(t,t,()=>a(d))}return h("\u23ED\uFE0F","Child context already finished, returning cached result:",{entityId:t}),await U(u,E,t,n,r.terminationManager,r.durableExecutionArn)},at=async(r,e,t,n,a,i,o,l,u,c)=>{let E=o?.serdes||W;if(r.getStepData(n)===void 0){let f=o?.subType||D.RUN_IN_CHILD_CONTEXT;e.checkpoint(n,{Id:n,ParentId:c,Action:m.OperationAction.START,SubType:f,Type:m.OperationType.CONTEXT,Name:a})}let d=tt(r,n),s=u(r,t,d,l(),n,void 0,n);try{let f=await Y(n,c,()=>i(s),void 0,d),g=await se(E,f,n,a,r.terminationManager,r.durableExecutionArn),p=g,C=!1;g&&Buffer.byteLength(g,"utf8")>ke&&(C=!0,o?.summaryGenerator?p=o.summaryGenerator(f):p="",h("\u{1F4E6}","Large payload detected, using ReplayChildren mode:",{entityId:n,name:a,payloadSize:Buffer.byteLength(g,"utf8"),limit:ke})),e.markAncestorFinished(n);let b=o?.subType||D.RUN_IN_CHILD_CONTEXT;return e.checkpoint(n,{Id:n,ParentId:c,Action:m.OperationAction.SUCCEED,SubType:b,Type:m.OperationType.CONTEXT,Payload:p,ContextOptions:C?{ReplayChildren:!0}:void 0,Name:a}),h("\u2705","Child context completed successfully:",{entityId:n,name:a}),f}catch(f){h("\u274C","Child context failed:",{entityId:n,name:a,error:f}),e.markAncestorFinished(n);let g=o?.subType||D.RUN_IN_CHILD_CONTEXT;e.checkpoint(n,{Id:n,ParentId:c,Action:m.OperationAction.FAIL,SubType:g,Type:m.OperationType.CONTEXT,Error:P(f),Name:a});let p=P(f),C=L.fromErrorObject(p);throw new F(C.message,C)}},it=(r,e,t,n,a)=>{function i(o,l){let u=typeof o=="string",c=u?o:void 0,d=$(u?l:o),s=t(),f=!1,g=(async()=>{h("\u23F2\uFE0F","Wait phase 1:",{stepId:s,name:c,seconds:d});let p=r.getStepData(s);if(X(s,{type:m.OperationType.WAIT,name:c,subType:D.WAIT},p,r),p?.Status===m.OperationStatus.SUCCEEDED){h("\u23ED\uFE0F","Wait already completed:",{stepId:s}),a?.(),e.markOperationState(s,S.COMPLETED,{metadata:{stepId:s,name:c,type:m.OperationType.WAIT,subType:D.WAIT,parentId:n}}),f=!0;return}p||await e.checkpoint(s,{Id:s,ParentId:n,Action:m.OperationAction.START,SubType:D.WAIT,Type:m.OperationType.WAIT,Name:c,WaitOptions:{WaitSeconds:d}}),p=r.getStepData(s),e.markOperationState(s,S.IDLE_NOT_AWAITED,{metadata:{stepId:s,name:c,type:m.OperationType.WAIT,subType:D.WAIT,parentId:n},endTimestamp:p?.WaitDetails?.ScheduledEndTimestamp}),h("\u2705","Wait phase 1 complete:",{stepId:s})})();return g.catch(()=>{}),new x(async()=>{if(await g,f)return;h("\u23F2\uFE0F","Wait phase 2:",{stepId:s}),e.markOperationAwaited(s),await e.waitForStatusChange(s);let p=r.getStepData(s);if(p?.Status===m.OperationStatus.SUCCEEDED){h("\u2705","Wait completed:",{stepId:s}),a?.(),e.markOperationState(s,S.COMPLETED);return}h("\u26A0\uFE0F","Wait ended with unexpected status:",{stepId:s,status:p?.Status})})}return i},ot=(r,e,t,n,a)=>(i,o,l)=>{let u,c,E;if(typeof i=="string"||i===void 0?(u=i,c=o,E=l):(c=i,E=o),!E?.waitStrategy||E.initialState===void 0)throw new Error("waitForCondition requires config with waitStrategy and initialState");let d=t(),s=E.serdes||W,f=(async()=>{let g=r.getStepData(d);if(g?.Status===m.OperationStatus.SUCCEEDED)return h("\u23ED\uFE0F","WaitForCondition already completed:",{stepId:d}),e.markOperationState(d,S.COMPLETED,{metadata:{stepId:d,name:u,type:m.OperationType.STEP,subType:D.WAIT_FOR_CONDITION,parentId:a}}),await U(s,g.StepDetails?.Result,d,u,r.terminationManager,r.durableExecutionArn);if(g?.Status===m.OperationStatus.FAILED)throw e.markOperationState(d,S.COMPLETED,{metadata:{stepId:d,name:u,type:m.OperationType.STEP,subType:D.WAIT_FOR_CONDITION,parentId:a}}),g.StepDetails?.Error?L.fromErrorObject(g.StepDetails.Error):new re("waitForCondition failed");if(g?.Status===m.OperationStatus.PENDING)return e.markOperationState(d,S.RETRY_WAITING,{metadata:{stepId:d,name:u,type:m.OperationType.STEP,subType:D.WAIT_FOR_CONDITION,parentId:a},endTimestamp:g.StepDetails?.NextAttemptTimestamp}),(async()=>(await e.waitForRetryTimer(d),g=r.getStepData(d),await p()))();return await p();async function p(){g=r.getStepData(d);let C;if(g?.Status===m.OperationStatus.STARTED||g?.Status===m.OperationStatus.READY){let y=g.StepDetails?.Result;if(y)try{let T={entityId:d,durableExecutionArn:r.durableExecutionArn};C=await s.deserialize(y,T)}catch{C=E.initialState}else C=E.initialState}else C=E.initialState;let b=(g?.StepDetails?.Attempt??0)+1;g?.Status!==m.OperationStatus.STARTED&&e.checkpoint(d,{Id:d,ParentId:a,Action:m.OperationAction.START,SubType:D.WAIT_FOR_CONDITION,Type:m.OperationType.STEP,Name:u});try{let y={logger:n};e.markOperationState(d,S.EXECUTING,{metadata:{stepId:d,name:u,type:m.OperationType.STEP,subType:D.WAIT_FOR_CONDITION,parentId:a}});let T=await Y(d,a,()=>c(C,y),b,I.ExecutionMode),w=await se(s,T,d,u,r.terminationManager,r.durableExecutionArn),A=await U(s,w,d,u,r.terminationManager,r.durableExecutionArn),N=E.waitStrategy(A,b);return N.shouldContinue?(await e.checkpoint(d,{Id:d,ParentId:a,Action:m.OperationAction.RETRY,SubType:D.WAIT_FOR_CONDITION,Type:m.OperationType.STEP,Payload:w,Name:u,StepOptions:{NextAttemptDelaySeconds:$(N.delay)}}),e.markOperationState(d,S.RETRY_WAITING,{metadata:{stepId:d,name:u,type:m.OperationType.STEP,subType:D.WAIT_FOR_CONDITION,parentId:a},endTimestamp:r.getStepData(d)?.StepDetails?.NextAttemptTimestamp}),await e.waitForRetryTimer(d),await p()):(await e.checkpoint(d,{Id:d,ParentId:a,Action:m.OperationAction.SUCCEED,SubType:D.WAIT_FOR_CONDITION,Type:m.OperationType.STEP,Payload:w,Name:u}),e.markOperationState(d,S.COMPLETED),A)}catch(y){throw await e.checkpoint(d,{Id:d,ParentId:a,Action:m.OperationAction.FAIL,SubType:D.WAIT_FOR_CONDITION,Type:m.OperationType.STEP,Error:P(y),Name:u}),e.markOperationState(d,S.COMPLETED),L.fromErrorObject(P(y))}}})();return f.catch(()=>{}),new x(async()=>(e.markOperationAwaited(d),await f))},st=(r,e,t,n,a,i)=>new x(async()=>{h("\u{1F504}","Callback promise phase 2:",{stepId:t,stepName:n}),e.markOperationAwaited(t),await e.waitForStatusChange(t);let o=r.getStepData(t);if(o?.Status===m.OperationStatus.SUCCEEDED){h("\u2705","Callback completed:",{stepId:t}),i(),e.markOperationState(t,S.COMPLETED);let c=o.CallbackDetails;if(!c)throw new O(`No callback data found for completed callback: ${t}`);return await U(a,c.Result,t,n,r.terminationManager,r.durableExecutionArn)}h("\u274C","Callback failed:",{stepId:t,status:o?.Status}),e.markOperationState(t,S.COMPLETED);let u=o?.CallbackDetails?.Error;if(u){let c=new Error(u.ErrorMessage);throw c.name=u.ErrorType||"Error",c.stack=u.StackTrace?.join(`
`),new O(u.ErrorMessage||"Callback failed",c,u.ErrorData)}throw new O("Callback failed")}),_e=()=>({serialize:async r=>r,deserialize:async r=>r}),ct=(r,e,t,n,a)=>(i,o)=>{let l,u;typeof i=="string"||i===void 0?(l=i,u=o):u=i;let c=t(),E=u?.serdes||_e(),d=!1,s=(async()=>{h("\u{1F4DE}","Callback phase 1:",{stepId:c,name:l});let f=r.getStepData(c);if(X(c,{type:m.OperationType.CALLBACK,name:l,subType:D.CALLBACK},f,r),f?.Status===m.OperationStatus.SUCCEEDED){h("\u23ED\uFE0F","Callback already completed:",{stepId:c}),n(),e.markOperationState(c,S.COMPLETED,{metadata:{stepId:c,name:l,type:m.OperationType.CALLBACK,subType:D.CALLBACK,parentId:a}}),d=!0;return}if(f?.Status===m.OperationStatus.FAILED||f?.Status===m.OperationStatus.TIMED_OUT){h("\u274C","Callback already failed:",{stepId:c}),e.markOperationState(c,S.COMPLETED,{metadata:{stepId:c,name:l,type:m.OperationType.CALLBACK,subType:D.CALLBACK,parentId:a}}),d=!0;return}f||(await e.checkpoint(c,{Id:c,ParentId:a,Action:"START",SubType:D.CALLBACK,Type:m.OperationType.CALLBACK,Name:l,CallbackOptions:{TimeoutSeconds:u?.timeout?$(u.timeout):void 0,HeartbeatTimeoutSeconds:u?.heartbeatTimeout?$(u.heartbeatTimeout):void 0}}),f=r.getStepData(c)),e.markOperationState(c,S.IDLE_NOT_AWAITED,{metadata:{stepId:c,name:l,type:m.OperationType.CALLBACK,subType:D.CALLBACK,parentId:a}}),h("\u2705","Callback phase 1 complete:",{stepId:c})})();return s.catch(()=>{}),new x(async()=>{if(await s,d){let b=r.getStepData(c),y=b?.CallbackDetails;if(!y?.CallbackId)throw new O(`No callback ID found for callback: ${c}`);if(b?.Status===m.OperationStatus.SUCCEEDED){let N=await U(E,y.Result,c,l,r.terminationManager,r.durableExecutionArn);return[new x(async()=>N),y.CallbackId]}let T=b?.CallbackDetails?.Error,w=T?(()=>{let N=new Error(T.ErrorMessage);return N.name=T.ErrorType||"Error",N.stack=T.StackTrace?.join(`
`),new O(T.ErrorMessage||"Callback failed",N,T.ErrorData)})():new O("Callback failed");return[new x(async()=>{throw w}),y.CallbackId]}h("\u{1F4DE}","Callback phase 2:",{stepId:c});let g=r.getStepData(c)?.CallbackDetails;if(!g?.CallbackId)throw new O(`No callback ID found for started callback: ${c}`);let p=g.CallbackId,C=st(r,e,c,l,E,n);return h("\u2705","Callback created:",{stepId:c,name:l,callbackId:p}),[C,p]})},ut=(r,e,t)=>(n,a,i)=>{let o,l,u;if(typeof n=="string"||n===void 0)if(o=n,typeof a=="function")l=a,u=i;else return new x(()=>Promise.reject(new Error("waitForCallback requires a submitter function when name is provided")));else if(typeof n=="function")l=n,u=a;else return new x(()=>Promise.reject(new Error("waitForCallback requires a submitter function")));let c=(async()=>{h("\u{1F4DE}","WaitForCallback requested:",{name:o,hasSubmitter:!!l,config:u});let E=async s=>{let f=u?{timeout:u.timeout,heartbeatTimeout:u.heartbeatTimeout}:void 0,[g,p]=await s.createCallback(f);return h("\u{1F194}","Callback created:",{callbackId:p,name:o}),await s.step(async C=>{let b={logger:C.logger};h("\u{1F4E4}","Executing submitter:",{callbackId:p,name:o}),await l(p,b),h("\u2705","Submitter completed:",{callbackId:p,name:o})},u?.retryStrategy?{retryStrategy:u.retryStrategy}:void 0),h("\u23F3","Waiting for callback completion:",{callbackId:p,name:o}),await g},d=e();return{result:await t(o,E,{subType:D.WAIT_FOR_CALLBACK}),stepId:d}})();return c.catch(()=>{}),new x(async()=>{let{result:E,stepId:d}=await c;return await U(u?.serdes??_e(),E,d,o,r.terminationManager,r.durableExecutionArn)})},lt=()=>r=>JSON.stringify({type:"ParallelResult",totalCount:r.totalCount,successCount:r.successCount,failureCount:r.failureCount,startedCount:r.startedCount,completionReason:r.completionReason,status:r.status}),dt=()=>r=>JSON.stringify({type:"MapResult",totalCount:r.totalCount,successCount:r.successCount,failureCount:r.failureCount,completionReason:r.completionReason,status:r.status}),ht=(r,e)=>(t,n,a,i)=>{let o=(async()=>{let l,u,c,E;if(typeof t=="string"||t===void 0?(l=t,u=n,c=a,E=i):(u=t,c=n,E=a),h("\u{1F5FA}\uFE0F","Starting map operation:",{name:l,itemCount:u.length,maxConcurrency:E?.maxConcurrency}),!Array.isArray(u))throw new Error("Map operation requires an array of items");if(typeof c!="function")throw new Error("Map operation requires a function to process items");let d=u.map((g,p)=>({id:`map-item-${p}`,data:g,index:p,name:E?.itemNamer?E.itemNamer(g,p):void 0})),f=await e(l,d,async(g,p)=>c(p,g.data,g.index,u),{maxConcurrency:E?.maxConcurrency,topLevelSubType:D.MAP,iterationSubType:D.MAP_ITERATION,summaryGenerator:dt(),completionConfig:E?.completionConfig,serdes:E?.serdes,itemSerdes:E?.itemSerdes});return h("\u{1F5FA}\uFE0F","Map operation completed successfully:",{resultCount:f.totalCount}),f})();return o.catch(()=>{}),new x(async()=>await o)},mt=(r,e)=>(t,n,a)=>{let i=(async()=>{let o,l,u;if(typeof t=="string"||t===void 0?(o=t,l=n,u=a):(l=t,u=n),!Array.isArray(l))throw new Error("Parallel operation requires an array of branch functions");if(h("\u{1F500}","Starting parallel operation:",{name:o,branchCount:l.length,maxConcurrency:u?.maxConcurrency}),l.some(s=>typeof s!="function"&&(typeof s!="object"||typeof s.func!="function")))throw new Error("All branches must be functions or NamedParallelBranch objects");let c=l.map((s,f)=>{let g=typeof s=="object"&&"func"in s,p=g?s.func:s,C=g?s.name:void 0;return{id:`parallel-branch-${f}`,data:p,index:f,name:C}}),d=await e(o,c,async(s,f)=>{h("\u{1F500}","Processing parallel branch:",{index:s.index});let g=await s.data(f);return h("\u2705","Parallel branch completed:",{index:s.index,result:g}),g},{maxConcurrency:u?.maxConcurrency,topLevelSubType:D.PARALLEL,iterationSubType:D.PARALLEL_BRANCH,summaryGenerator:lt(),completionConfig:u?.completionConfig,serdes:u?.serdes,itemSerdes:u?.itemSerdes});return h("\u{1F500}","Parallel operation completed successfully:",{resultCount:d.totalCount}),d})();return i.catch(()=>{}),new x(async()=>await i)};function pt(r){return r.map(e=>e&&e.status==="rejected"&&e.reason instanceof Error?{...e,reason:{message:e.reason.message,name:e.reason.name,stack:e.reason.stack}}:e)}function Et(r){return r.map(e=>{if(e&&e.status==="rejected"&&e.reason&&typeof e.reason=="object"&&e.reason.message){let t=new Error(e.reason.message);return t.name=e.reason.name||"Error",e.reason.stack&&(t.stack=e.reason.stack),{...e,reason:t}}return e})}function ft(){return{serialize:async(r,e)=>r!==void 0?JSON.stringify(pt(r)):void 0,deserialize:async(r,e)=>r!==void 0?Et(JSON.parse(r)):void 0}}var Z={retryStrategy:()=>({shouldRetry:!1})},gt=r=>{let e=(o,l)=>typeof o=="string"||o===void 0?{name:o,promises:l}:{name:void 0,promises:o};return{all:(o,l)=>new x(async()=>{let{name:u,promises:c}=e(o,l);return await r(u,()=>Promise.all(c),Z)}),allSettled:(o,l)=>new x(async()=>{let{name:u,promises:c}=e(o,l);return await r(u,()=>Promise.allSettled(c),{...Z,serdes:ft()})}),any:(o,l)=>new x(async()=>{let{name:u,promises:c}=e(o,l);return await r(u,()=>Promise.any(c),Z)}),race:(o,l)=>new x(async()=>{let{name:u,promises:c}=e(o,l);return await r(u,()=>Promise.race(c),Z)})}},G=class{all;completionReason;constructor(e,t){this.all=e,this.completionReason=t}succeeded(){return this.all.filter(e=>e.status===k.SUCCEEDED&&e.result!==void 0)}failed(){return this.all.filter(e=>e.status===k.FAILED&&e.error!==void 0)}started(){return this.all.filter(e=>e.status===k.STARTED)}get status(){return this.hasFailure?k.FAILED:k.SUCCEEDED}get hasFailure(){return this.all.some(e=>e.status===k.FAILED)}throwIfError(){let e=this.all.find(t=>t.status===k.FAILED)?.error;if(e)throw e}getResults(){return this.succeeded().map(e=>e.result)}getErrors(){return this.failed().map(e=>e.error)}get successCount(){return this.all.filter(e=>e.status===k.SUCCEEDED).length}get failureCount(){return this.all.filter(e=>e.status===k.FAILED).length}get startedCount(){return this.all.filter(e=>e.status===k.STARTED).length}get totalCount(){return this.all.length}};function Ct(r){if(r&&typeof r=="object"&&"all"in r&&Array.isArray(r.all)){let e=r,t=e.all.map(n=>({...n,result:n.result,error:n.error?L.fromErrorObject(n.error):void 0}));return new G(t,e.completionReason)}return new G([],"ALL_COMPLETED")}var me=class{operationName;skipNextOperation;constructor(e,t){this.operationName=e,this.skipNextOperation=t}isChildEntityCompleted(e,t,n){let a=`${t}-${n+1}`,i=e.getStepData(a);return!!(i&&(i.Status===m.OperationStatus.SUCCEEDED||i.Status===m.OperationStatus.FAILED))}getCompletionReason(e,t,n,a,i){let o=i.completionConfig;if(o){if(Object.values(o).some(u=>u!==void 0)){if(o.toleratedFailureCount!==void 0&&e>o.toleratedFailureCount||o.toleratedFailurePercentage!==void 0&&e/a.length*100>o.toleratedFailurePercentage)return"FAILURE_TOLERANCE_EXCEEDED"}else if(e>0)return"FAILURE_TOLERANCE_EXCEEDED"}else if(e>0)return"FAILURE_TOLERANCE_EXCEEDED";return n===a.length?"ALL_COMPLETED":i.completionConfig?.minSuccessful!==void 0&&t>=i.completionConfig.minSuccessful?"MIN_SUCCESSFUL_REACHED":"ALL_COMPLETED"}async executeItems(e,t,n,a,i=I.ExecutionMode,o,l){if(i===I.ReplaySucceededContext){h("\u{1F504}",`Replay mode: Reconstructing ${this.operationName} result:`,{itemCount:e.length});let u;if(o&&l){let E=l.getStepData(o)?.ContextDetails?.Result;if(E)try{let s=await(a.serdes||W).deserialize(E,{entityId:o,durableExecutionArn:l.durableExecutionArn});s&&typeof s=="object"&&"totalCount"in s&&(u=s.totalCount,h("\u{1F4CA}","Found initial execution count:",{targetTotalCount:u}))}catch(d){h("\u26A0\uFE0F","Could not parse initial result summary:",d)}}if(u!==void 0&&o&&l)return await this.replayItems(e,t,n,a,u,l,o);h("\u26A0\uFE0F","No valid target count or context found, falling back to concurrent execution")}return await this.executeItemsConcurrently(e,t,n,a)}async replayItems(e,t,n,a,i,o,l){let u=[];h("\u{1F504}",`Replaying ${e.length} items sequentially`,{targetTotalCount:i});let c=0,E=0;for(let f of e){if(c>=i){h("\u2705","Reached target count, stopping replay",{completedCount:c,targetTotalCount:i});break}let g=`${l}-${E+1}`;if(!this.isChildEntityCompleted(o,l,E)){h("\u23ED\uFE0F","Skipping incomplete item:",{index:f.index,itemId:f.id,childEntityId:g}),this.skipNextOperation(),E++;continue}try{let p=await n.runInChildContext(f.name||f.id,C=>t(f,C),{subType:a.iterationSubType,serdes:a.itemSerdes});u.push({result:p,index:f.index,status:k.SUCCEEDED}),c++,E++,h("\u2705",`Replayed ${this.operationName} item:`,{index:f.index,itemId:f.id,completedCount:c})}catch(p){let C=p instanceof F?p:new F(p instanceof Error?p.message:String(p),p instanceof Error?p:void 0);u.push({error:C,index:f.index,status:k.FAILED}),c++,E++,h("\u274C",`Replay failed for ${this.operationName} item:`,{index:f.index,itemId:f.id,error:C.message,completedCount:c})}}h("\u{1F389}",`${this.operationName} replay completed:`,{completedCount:c,totalCount:u.length});let d=u.filter(f=>f.status===k.SUCCEEDED).length,s=c-d;return new G(u,this.getCompletionReason(s,d,c,e,a))}async executeItemsConcurrently(e,t,n,a){let i=a.maxConcurrency||1/0,o=new Array(e.length),l=new Set,u=0,c=0,E=0,d=0,s=0;return h("\u{1F680}",`Starting ${this.operationName} with concurrency control:`,{itemCount:e.length,maxConcurrency:i}),new Promise(f=>{let g=()=>{let T=a.completionConfig;return!T||!Object.values(T).some(A=>A!==void 0)?s===0:!(T.toleratedFailureCount!==void 0&&s>T.toleratedFailureCount||T.toleratedFailurePercentage!==void 0&&s/e.length*100>T.toleratedFailurePercentage)},p=()=>{if(E===e.length)return!0;let T=a.completionConfig;return T?.minSuccessful!==void 0&&d>=T.minSuccessful},C=T=>this.getCompletionReason(T,d,E,e,a),b=()=>{for(;u<i&&c<e.length&&g();){let T=c++,w=e[T];l.add(T),u++,o[T]={index:T,status:k.STARTED},h("\u25B6\uFE0F",`Starting ${this.operationName} item:`,{index:T,itemId:w.id,itemName:w.name}),n.runInChildContext(w.name||w.id,A=>t(w,A),{subType:a.iterationSubType,serdes:a.itemSerdes}).then(A=>{o[T]={result:A,index:T,status:k.SUCCEEDED},d++,h("\u2705",`${this.operationName} item completed:`,{index:T,itemId:w.id,itemName:w.name}),y()},A=>{let N=A instanceof F?A:new F(A instanceof Error?A.message:String(A),A instanceof Error?A:void 0);o[T]={error:N,index:T,status:k.FAILED},s++,h("\u274C",`${this.operationName} item failed:`,{index:T,itemId:w.id,itemName:w.name,error:N.message}),y()})}},y=()=>{if(u--,E++,p()||!g()){let T=[];for(let A=0;A<o.length;A++)o[A]!==void 0&&T.push({...o[A]});h("\u{1F389}",`${this.operationName} completed:`,{successCount:d,failureCount:s,startedCount:T.filter(A=>A.status===k.STARTED).length,totalCount:T.length});let w=new G(T,C(s));f(w)}else b()};b()})}},Tt=(r,e,t)=>(n,a,i,o)=>{let l=(async()=>{let u,c,E,d;if(typeof n=="string"||n===void 0?(u=n,c=a,E=i,d=o):(c=n,E=a,d=i),h("\u{1F504}","Starting concurrent execution:",{name:u,itemCount:c.length,maxConcurrency:d?.maxConcurrency}),!Array.isArray(c))throw new Error("Concurrent execution requires an array of items");if(typeof E!="function")throw new Error("Concurrent execution requires an executor function");if(d?.maxConcurrency!==void 0&&d.maxConcurrency!==null&&d.maxConcurrency<=0)throw new Error(`Invalid maxConcurrency: ${d.maxConcurrency}. Must be a positive number or undefined for unlimited concurrency.`);let f=await e(u,async g=>{let p=new me("concurrent-execution",t),C=g.durableExecutionMode,b=g._stepPrefix;return h("\u{1F504}","Concurrent execution mode:",{mode:C,itemCount:c.length,entityId:b}),await p.executeItems(c,E,g,d||{},C,b,r)},{subType:d?.topLevelSubType,summaryGenerator:d?.summaryGenerator,serdes:d?.serdes});return f&&typeof f=="object"&&"all"in f&&Array.isArray(f.all)?Ct(f):f})();return l.catch(()=>{}),new x(async()=>await l)},pe=class{captureExecutionState;checkAndUpdateReplayMode;checkForNonResolvingPromise;getDurableExecutionMode;setDurableExecutionMode;constructor(e,t,n,a,i){this.captureExecutionState=e,this.checkAndUpdateReplayMode=t,this.checkForNonResolvingPromise=n,this.getDurableExecutionMode=a,this.setDurableExecutionMode=i}withModeManagement(e){let t=this.captureExecutionState();this.checkAndUpdateReplayMode();let n=this.checkForNonResolvingPromise();if(n)return n;try{return e()}finally{t&&this.setDurableExecutionMode(I.ExecutionMode)}}withDurableModeManagement(e){let t=this.captureExecutionState();this.checkAndUpdateReplayMode();let n=this.checkForNonResolvingPromise();if(n)return new x(async()=>{throw await n,new Error("Unreachable code")});try{return e()}finally{t&&this.setDurableExecutionMode(I.ExecutionMode)}}},yt=16,q=r=>(0,Ne.createHash)("md5").update(r).digest("hex").substring(0,yt),Dt=(r,e)=>{let t=q(e);return r[t]},Ee=class{executionContext;lambdaContext;_stepPrefix;_stepCounter=0;durableLogger;modeAwareLoggingEnabled=!0;checkpoint;durableExecutionMode;_parentId;modeManagement;durableExecution;logger;constructor(e,t,n,a,i,o,l){this.executionContext=e,this.lambdaContext=t,this._stepPrefix=i,this._parentId=l,this.durableExecution=o,this.durableLogger=a,this.durableLogger.configureDurableLoggingContext?.(this.getDurableLoggingContext()),this.logger=this.createModeAwareLogger(a),this.durableExecutionMode=n,this.checkpoint=o.checkpointManager,this.modeManagement=new pe(this.captureExecutionState.bind(this),this.checkAndUpdateReplayMode.bind(this),this.checkForNonResolvingPromise.bind(this),()=>this.durableExecutionMode,u=>{this.durableExecutionMode=u})}getDurableLoggingContext(){return{getDurableLogData:()=>{let e=he(),t={executionArn:this.executionContext.durableExecutionArn,requestId:this.executionContext.requestId,tenantId:this.executionContext.tenantId,operationId:!e||e?.contextId==="root"?void 0:q(e.contextId)};return e?.attempt!==void 0&&(t.attempt=e.attempt),t}}}shouldLog(){let e=he();return!this.modeAwareLoggingEnabled||!e?!0:e.contextId==="root"?this.durableExecutionMode===I.ExecutionMode:e.durableExecutionMode===I.ExecutionMode}createModeAwareLogger(e){let t={warn:(...n)=>{if(this.shouldLog())return e.warn(...n)},debug:(...n)=>{if(this.shouldLog())return e.debug(...n)},info:(...n)=>{if(this.shouldLog())return e.info(...n)},error:(...n)=>{if(this.shouldLog())return e.error(...n)}};return"log"in e&&(t.log=(n,...a)=>{if(this.shouldLog())return e.log?.(n,...a)}),t}createStepId(){return this._stepCounter++,this._stepPrefix?`${this._stepPrefix}-${this._stepCounter}`:`${this._stepCounter}`}getNextStepId(){let e=this._stepCounter+1;return this._stepPrefix?`${this._stepPrefix}-${e}`:`${e}`}skipNextOperation(){this._stepCounter++}checkAndUpdateReplayMode(){if(this.durableExecutionMode===I.ReplayMode){let e=this.getNextStepId();this.executionContext.getStepData(e)||(this.durableExecutionMode=I.ExecutionMode)}}captureExecutionState(){let e=this.durableExecutionMode===I.ReplayMode,t=this.getNextStepId(),n=this.executionContext.getStepData(t),a=!!(n&&n.Status!==m.OperationStatus.SUCCEEDED&&n.Status!==m.OperationStatus.FAILED);return e&&a}checkForNonResolvingPromise(){if(this.durableExecutionMode===I.ReplaySucceededContext){let e=this.getNextStepId(),t=this.executionContext.getStepData(e);if(t&&t.Status!==m.OperationStatus.SUCCEEDED&&t.Status!==m.OperationStatus.FAILED)return new Promise(()=>{})}return null}withModeManagement(e){return this.modeManagement.withModeManagement(e)}withDurableModeManagement(e){return this.modeManagement.withDurableModeManagement(e)}step(e,t,n){return M(this._stepPrefix,"step",this.executionContext.terminationManager),this.withDurableModeManagement(()=>Ze(this.executionContext,this.checkpoint,this.lambdaContext,this.createStepId.bind(this),this.durableLogger,this._parentId)(e,t,n))}invoke(e,t,n,a){return M(this._stepPrefix,"invoke",this.executionContext.terminationManager),this.withDurableModeManagement(()=>et(this.executionContext,this.checkpoint,this.createStepId.bind(this),this._parentId,this.checkAndUpdateReplayMode.bind(this))(e,t,n,a))}runInChildContext(e,t,n){return M(this._stepPrefix,"runInChildContext",this.executionContext.terminationManager),this.withDurableModeManagement(()=>rt(this.executionContext,this.checkpoint,this.lambdaContext,this.createStepId.bind(this),()=>this.durableLogger,(i,o,l,u,c,E,d)=>Oe(i,o,l,u,c,this.durableExecution,d),this._parentId)(e,t,n))}wait(e,t){return M(this._stepPrefix,"wait",this.executionContext.terminationManager),this.withDurableModeManagement(()=>{let n=it(this.executionContext,this.checkpoint,this.createStepId.bind(this),this._parentId,this.checkAndUpdateReplayMode.bind(this));return typeof e=="string"?n(e,t):n(e)})}configureLogger(e){e.customLogger!==void 0&&(this.durableLogger=e.customLogger,this.durableLogger.configureDurableLoggingContext?.(this.getDurableLoggingContext()),this.logger=this.createModeAwareLogger(this.durableLogger)),e.modeAware!==void 0&&(this.modeAwareLoggingEnabled=e.modeAware)}createCallback(e,t){return M(this._stepPrefix,"createCallback",this.executionContext.terminationManager),this.withDurableModeManagement(()=>ct(this.executionContext,this.checkpoint,this.createStepId.bind(this),this.checkAndUpdateReplayMode.bind(this),this._parentId)(e,t))}waitForCallback(e,t,n){return M(this._stepPrefix,"waitForCallback",this.executionContext.terminationManager),this.withDurableModeManagement(()=>ut(this.executionContext,this.getNextStepId.bind(this),this.runInChildContext.bind(this))(e,t,n))}waitForCondition(e,t,n){return M(this._stepPrefix,"waitForCondition",this.executionContext.terminationManager),this.withDurableModeManagement(()=>{let a=ot(this.executionContext,this.checkpoint,this.createStepId.bind(this),this.durableLogger,this._parentId);return typeof e=="string"||e===void 0?a(e,t,n):a(e,t)})}map(e,t,n,a){return M(this._stepPrefix,"map",this.executionContext.terminationManager),this.withDurableModeManagement(()=>ht(this.executionContext,this._executeConcurrently.bind(this))(e,t,n,a))}parallel(e,t,n){return M(this._stepPrefix,"parallel",this.executionContext.terminationManager),this.withDurableModeManagement(()=>mt(this.executionContext,this._executeConcurrently.bind(this))(e,t,n))}_executeConcurrently(e,t,n,a){return M(this._stepPrefix,"_executeConcurrently",this.executionContext.terminationManager),this.withDurableModeManagement(()=>{let o=Tt(this.executionContext,this.runInChildContext.bind(this),this.skipNextOperation.bind(this))(e,t,n,a);return o?.catch(()=>{}),o})}get promise(){return gt(this.step.bind(this))}},Oe=(r,e,t,n,a,i,o)=>new Ee(r,e,t,n,a,i,o),oe=class extends ie{terminationReason=R.CHECKPOINT_FAILED;constructor(e,t){super(e||"Checkpoint operation failed",t)}},fe=class extends ae{terminationReason=R.CHECKPOINT_FAILED;constructor(e,t){super(e||"Checkpoint operation failed",t)}},St="stepDataUpdated",ge=class r{durableExecutionArn;stepData;storage;terminationManager;stepDataEmitter;logger;finishedAncestors;queue=[];isProcessing=!1;currentTaskToken;forceCheckpointPromises=[];queueCompletionResolver=null;MAX_PAYLOAD_SIZE=750*1024;isTerminating=!1;static textEncoder=new TextEncoder;operations=new Map;terminationTimer=null;terminationReason=null;TERMINATION_COOLDOWN_MS=50;constructor(e,t,n,a,i,o,l,u){this.durableExecutionArn=e,this.stepData=t,this.storage=n,this.terminationManager=a,this.stepDataEmitter=o,this.logger=l,this.finishedAncestors=u,this.currentTaskToken=i}setTerminating(){this.isTerminating=!0,h("\u{1F6D1}","Checkpoint manager marked as terminating")}markAncestorFinished(e){this.finishedAncestors.add(e)}getParentId(e){let t=e.lastIndexOf("-");return t>0?e.substring(0,t):void 0}hasFinishedAncestor(e){let t=this.getParentId(e);for(;t;){if(this.finishedAncestors.has(t))return!0;t=this.getParentId(t)}return!1}async forceCheckpoint(){return this.isTerminating?(h("\u26A0\uFE0F","Force checkpoint skipped - termination in progress"),new Promise(()=>{})):new Promise((e,t)=>{this.forceCheckpointPromises.push({resolve:e,reject:t}),this.isProcessing||setImmediate(()=>{this.processQueue()})})}async waitForQueueCompletion(){if(!(this.queue.length===0&&!this.isProcessing))return new Promise(e=>{this.queueCompletionResolver=e})}clearQueue(){this.queue=[],this.forceCheckpointPromises=[],this.notifyQueueCompletion()}async force(){return this.forceCheckpoint()}async checkpoint(e,t){return this.isTerminating?(h("\u26A0\uFE0F","Checkpoint skipped - termination in progress:",{stepId:e}),new Promise(()=>{})):this.hasFinishedAncestor(e)?(h("\u26A0\uFE0F","Checkpoint skipped - ancestor already finished:",{stepId:e}),new Promise(()=>{})):new Promise((n,a)=>{let i={stepId:e,data:t,resolve:()=>{n()},reject:o=>{a(o)}};this.queue.push(i),h("\u{1F4E5}","Checkpoint queued:",{stepId:e,queueLength:this.queue.length,isProcessing:this.isProcessing}),this.isProcessing||setImmediate(()=>{this.processQueue()})})}classifyCheckpointError(e){let t=e instanceof Error?e:new Error(String(e)),n=e,a=n.$metadata?.httpStatusCode,i=n.name,o=n.message||t.message;return h("\u{1F50D}","Classifying checkpoint error:",{statusCode:a,errorName:i,errorMessage:o}),a&&a>=400&&a<500&&i==="InvalidParameterValueException"&&o.startsWith("Invalid Checkpoint Token")?new oe(`Checkpoint failed: ${o}`,t):a&&a>=400&&a<500&&a!==429?new fe(`Checkpoint failed: ${o}`,t):new oe(`Checkpoint failed: ${o}`,t)}async processQueue(){if(this.isProcessing)return;let e=this.queue.length>0,t=this.forceCheckpointPromises.length>0;if(!e&&!t)return;this.isProcessing=!0;let n=[],i=this.currentTaskToken.length+100;for(;this.queue.length>0;){let o=this.queue[0],l=r.textEncoder.encode(JSON.stringify(o)).length;if(i+l>this.MAX_PAYLOAD_SIZE&&n.length>0)break;this.queue.shift(),n.push(o),i+=l}h("\u{1F504}","Processing checkpoint batch:",{batchSize:n.length,remainingInQueue:this.queue.length,estimatedSize:i,maxSize:this.MAX_PAYLOAD_SIZE});try{(n.length>0||this.forceCheckpointPromises.length>0)&&await this.processBatch(n),n.forEach(l=>{l.resolve()});let o=this.forceCheckpointPromises.splice(0);o.forEach(l=>{l.resolve()}),h("\u2705","Checkpoint batch processed successfully:",{batchSize:n.length,forceRequests:o.length,newTaskToken:this.currentTaskToken})}catch(o){h("\u274C","Checkpoint batch failed:",{batchSize:n.length,error:o});let l=this.classifyCheckpointError(o);this.clearQueue(),this.terminationManager.terminate({reason:R.CHECKPOINT_FAILED,message:l.message,error:l})}finally{this.isProcessing=!1,this.queue.length>0?setImmediate(()=>{this.processQueue()}):this.notifyQueueCompletion()}}notifyQueueCompletion(){this.queueCompletionResolver&&(this.queueCompletionResolver(),this.queueCompletionResolver=null)}async processBatch(e){let t=e.map(i=>{let o=q(i.stepId);return{Type:i.data.Type||"STEP",Action:i.data.Action||"START",...i.data,Id:o,...i.data.ParentId&&{ParentId:q(i.data.ParentId)}}}),n={DurableExecutionArn:this.durableExecutionArn,CheckpointToken:this.currentTaskToken,Updates:t};h("\u23FA\uFE0F","Creating checkpoint batch:",{batchSize:t.length,checkpointToken:this.currentTaskToken,updates:t.map(i=>({Id:i.Id,Action:i.Action,Type:i.Type}))});let a=await this.storage.checkpoint(n,this.logger);a.CheckpointToken&&(this.currentTaskToken=a.CheckpointToken),a.NewExecutionState?.Operations&&this.updateStepDataFromCheckpointResponse(a.NewExecutionState.Operations)}updateStepDataFromCheckpointResponse(e){h("\u{1F504}","Updating stepData from checkpoint response:",{operationCount:e.length,operationIds:e.map(t=>t.Id).filter(Boolean)}),e.forEach(t=>{if(t.Id){let n=this.stepData[t.Id]?.Status,a=t.Status;this.stepData[t.Id]=t,h("\u{1F4DD}","Updated stepData entry:",t),this.stepDataEmitter.emit(St,t.Id),n!==a&&this.resolveWaitingOperation(t.Id)}}),h("\u2705","StepData update completed:",{totalStepDataEntries:Object.keys(this.stepData).length})}resolveWaitingOperation(e){for(let[t,n]of this.operations.entries())if(q(t)===e&&n.resolver){h("\u2705",`Resolving waiting operation ${t} due to status change`),n.resolver(),n.resolver=void 0,n.timer&&(clearTimeout(n.timer),n.timer=void 0);break}}getQueueStatus(){return{queueLength:this.queue.length,isProcessing:this.isProcessing}}markOperationState(e,t,n){let a=this.operations.get(e);if(a)a.state=t,n?.endTimestamp!==void 0&&(a.endTimestamp=n.endTimestamp);else{if(!n?.metadata)throw new Error(`metadata required on first call for ${e}`);a={stepId:e,state:t,metadata:n.metadata,endTimestamp:n.endTimestamp},this.operations.set(e,a)}t===S.COMPLETED&&this.cleanupOperation(e),t!==S.IDLE_NOT_AWAITED&&this.checkAndTerminate()}waitForRetryTimer(e){let t=this.operations.get(e);if(!t)throw new Error(`Operation ${e} not found`);if(t.state!==S.RETRY_WAITING)throw new Error(`Operation ${e} must be in RETRY_WAITING state, got ${t.state}`);return this.startTimerWithPolling(e,t.endTimestamp),new Promise(n=>{t.resolver=n})}waitForStatusChange(e){let t=this.operations.get(e);if(!t)throw new Error(`Operation ${e} not found`);if(t.state!==S.IDLE_AWAITED)throw new Error(`Operation ${e} must be in IDLE_AWAITED state, got ${t.state}`);return this.startTimerWithPolling(e,t.endTimestamp),new Promise(n=>{t.resolver=n})}markOperationAwaited(e){let t=this.operations.get(e);if(!t){h("\u26A0\uFE0F",`Cannot mark operation as awaited: ${e} not found`);return}t.state===S.IDLE_NOT_AWAITED&&(t.state=S.IDLE_AWAITED,h("\u{1F4CD}",`Operation marked as awaited: ${e}`),this.checkAndTerminate())}getOperationState(e){return this.operations.get(e)?.state}getAllOperations(){return new Map(this.operations)}cleanupOperation(e){let t=this.operations.get(e);t&&(t.timer&&(clearTimeout(t.timer),t.timer=void 0),t.resolver=void 0)}cleanupAllOperations(){for(let e of this.operations.values())e.timer&&(clearTimeout(e.timer),e.timer=void 0),e.resolver=void 0}checkAndTerminate(){if(this.queue.length>0){this.abortTermination();return}if(this.isProcessing){this.abortTermination();return}if(this.forceCheckpointPromises.length>0){this.abortTermination();return}let e=Array.from(this.operations.values());if(e.some(i=>i.state===S.EXECUTING)){this.abortTermination();return}for(let i of e)if(i.state===S.RETRY_WAITING||i.state===S.IDLE_NOT_AWAITED||i.state===S.IDLE_AWAITED){let o=i.metadata.stepId;this.hasFinishedAncestor(o)&&(h("\u{1F9F9}",`Cleaning up operation with completed ancestor: ${o}`),this.cleanupOperation(i.stepId),this.operations.delete(i.stepId))}let n=Array.from(this.operations.values());if(n.some(i=>i.state===S.RETRY_WAITING||i.state===S.IDLE_NOT_AWAITED||i.state===S.IDLE_AWAITED)){let i=this.determineTerminationReason(n);this.scheduleTermination(i)}else this.abortTermination()}abortTermination(){this.terminationTimer&&(clearTimeout(this.terminationTimer),this.terminationTimer=null,this.terminationReason=null,h("\u{1F504}","Termination aborted - conditions changed"))}scheduleTermination(e){this.terminationTimer&&this.terminationReason===e||(this.abortTermination(),this.terminationReason=e,h("\u23F1\uFE0F","Scheduling termination",{reason:e,cooldownMs:this.TERMINATION_COOLDOWN_MS}),this.terminationTimer=setTimeout(()=>{this.executeTermination(e)},this.TERMINATION_COOLDOWN_MS))}executeTermination(e){h("\u{1F6D1}","Executing termination after cooldown",{reason:e}),this.terminationTimer=null,this.terminationReason=null,this.cleanupAllOperations(),this.terminationManager.terminate({reason:e})}determineTerminationReason(e){return e.some(t=>t.state===S.RETRY_WAITING&&t.metadata.subType==="Step")?R.RETRY_SCHEDULED:e.some(t=>(t.state===S.IDLE_NOT_AWAITED||t.state===S.IDLE_AWAITED)&&t.metadata.subType==="Wait")?R.WAIT_SCHEDULED:R.CALLBACK_PENDING}startTimerWithPolling(e,t){let n=this.operations.get(e);if(!n)return;let a;if(t){let i=t instanceof Date?t:new Date(t);a=Math.max(0,i.getTime()-Date.now())}else a=1e3;n.pollCount||(n.pollCount=0,n.pollStartTime=Date.now()),n.timer=setTimeout(()=>{this.forceRefreshAndCheckStatus(e)},a)}async forceRefreshAndCheckStatus(e){let t=this.operations.get(e);if(!t)return;let n=900*1e3;if(t.pollStartTime&&Date.now()-t.pollStartTime>n){h("\u23F1\uFE0F",`Max polling duration (15 min) exceeded for ${e}, stopping poll`),t.timer&&(clearTimeout(t.timer),t.timer=void 0);return}let a=this.stepData[q(e)]?.Status;await this.forceCheckpoint();let i=this.stepData[q(e)]?.Status;if(i!==a)h("\u2705",`Status changed for ${e}: ${a} \u2192 ${i}`),t.resolver?.(),t.resolver=void 0,t.timer&&(clearTimeout(t.timer),t.timer=void 0);else{t.pollCount=(t.pollCount||0)+1;let o=Math.min(t.pollCount*1e3,1e4);t.timer=setTimeout(()=>{this.forceRefreshAndCheckStatus(e)},o)}}},Ce=class extends we.EventEmitter{isTerminated=!1;terminationDetails;resolveTermination;terminationPromise;setCheckpointTerminating;constructor(e){super(),this.setCheckpointTerminating=e,this.terminationPromise=new Promise(t=>{this.resolveTermination=t})}setCheckpointTerminatingCallback(e){this.setCheckpointTerminating=e}terminate(e={}){this.isTerminated||(this.setCheckpointTerminating?.(),this.isTerminated=!0,this.terminationDetails={reason:e.reason??R.OPERATION_TERMINATED,message:e.message??"Operation terminated",error:e.error,cleanup:e.cleanup},this.resolveTermination&&this.handleTermination(this.terminationDetails).then(this.resolveTermination))}getTerminationPromise(){return this.terminationPromise}async handleTermination(e){if(e.cleanup)try{await e.cleanup()}catch{}return{reason:e.reason,message:e.message,error:e.error}}};function wt(r,e){return e instanceof Error?Object.assign({errorType:e?.constructor?.name??"UnknownError",errorMessage:e.message,stackTrace:typeof e.stack=="string"?e.stack.split(`
`):e.stack},e):e}function ee(r,e,...t){let n={requestId:e.requestId,timestamp:new Date().toISOString(),level:r.toUpperCase(),executionArn:e.executionArn},a=e.tenantId;if(a!=null&&a!=null&&(n.tenantId=a),e.operationId!==void 0&&(n.operationId=e.operationId),e.attempt!==void 0&&(n.attempt=e.attempt),t.length===1){n.message=t[0];try{return JSON.stringify(n,wt)}catch{return n.message=ue.default.format(n.message),JSON.stringify(n)}}n.message=ue.default.format(...t);for(let i of t)if(i instanceof Error){n.errorType=i?.constructor?.name??"UnknownError",n.errorMessage=i.message,n.stackTrace=typeof i.stack=="string"?i.stack.split(`
`):[];break}return JSON.stringify(n)}var Te=class{consoleLogger;durableLoggingContext=void 0;executionContext;noOpLog=()=>{};constructor(e){this.executionContext=e,this.consoleLogger=new Pe.Console({stdout:process.stdout,stderr:process.stderr}),this.info=this.noOpLog,this.error=this.noOpLog,this.warn=this.noOpLog,this.debug=this.noOpLog,this.configureLogLevel()}configureLogLevel(){let e={DEBUG:{name:"DEBUG",priority:2},INFO:{name:"INFO",priority:3},WARN:{name:"WARN",priority:4},ERROR:{name:"ERROR",priority:5}},t=process.env.AWS_LAMBDA_LOG_LEVEL?.toUpperCase(),n=t&&t in e?e[t]:e.DEBUG;e.DEBUG.priority>=n.priority&&(this.debug=(a,...i)=>{let o=this.ensureDurableLoggingContext(),l=a!==void 0?[a,...i]:i;this.consoleLogger.debug(ee(_.DEBUG,o.getDurableLogData(),...l))}),e.INFO.priority>=n.priority&&(this.info=(a,...i)=>{let o=this.ensureDurableLoggingContext(),l=a!==void 0?[a,...i]:i;this.consoleLogger.info(ee(_.INFO,o.getDurableLogData(),...l))}),e.WARN.priority>=n.priority&&(this.warn=(a,...i)=>{let o=this.ensureDurableLoggingContext(),l=a!==void 0?[a,...i]:i;this.consoleLogger.warn(ee(_.WARN,o.getDurableLogData(),...l))}),e.ERROR.priority>=n.priority&&(this.error=(a,...i)=>{let o=this.ensureDurableLoggingContext(),l=a!==void 0?[a,...i]:i;this.consoleLogger.error(ee(_.ERROR,o.getDurableLogData(),...l))})}ensureDurableLoggingContext(){let e=this.executionContext;if(!this.durableLoggingContext&&!e)throw new Error("DurableLoggingContext is not configured. Please call configureDurableLoggingContext before logging.");if(this.durableLoggingContext)return this.durableLoggingContext;if(!e)throw new Error("Execution context is not provided.");return{getDurableLogData:()=>({requestId:e.requestId,executionArn:e.durableExecutionArn,tenantId:e.tenantId})}}log(e,t,...n){switch(e){case _.DEBUG:this.debug(t,...n);break;case _.INFO:this.info(t,...n);break;case _.WARN:this.warn(t,...n);break;case _.ERROR:this.error(t,...n);break;default:this.info(t,...n);break}}info;error;warn;debug;configureDurableLoggingContext(e){this.durableLoggingContext=e}},ye=r=>new Te(r),ce,De=class{client;constructor(e){e?this.client=e:(ce||(ce=new m.LambdaClient({requestHandler:{connectionTimeout:5e3,socketTimeout:5e4,requestTimeout:55e3,throwOnRequestTimeout:!0}})),this.client=ce)}async getExecutionState(e,t){try{return await this.client.send(new m.GetDurableExecutionStateCommand({DurableExecutionArn:e.DurableExecutionArn,CheckpointToken:e.CheckpointToken,Marker:e.Marker,MaxItems:e.MaxItems}))}catch(n){throw h("\u274C","GetDurableExecutionState failed",{error:n,requestId:n?.$metadata?.requestId,DurableExecutionArn:e.DurableExecutionArn,CheckpointToken:e.CheckpointToken,Marker:e.Marker}),t&&t.error("Failed to get durable execution state",n,{requestId:n?.$metadata?.requestId}),n}}async checkpoint(e,t){try{return await this.client.send(new m.CheckpointDurableExecutionCommand({DurableExecutionArn:e.DurableExecutionArn,CheckpointToken:e.CheckpointToken,ClientToken:e.ClientToken,Updates:e.Updates}))}catch(n){throw h("\u274C","CheckpointDurableExecution failed",{error:n,requestId:n?.$metadata?.requestId,DurableExecutionArn:e.DurableExecutionArn,CheckpointToken:e.CheckpointToken,ClientToken:e.ClientToken}),t&&t.error("Failed to checkpoint durable execution",n,{requestId:n?.$metadata?.requestId}),n}}},Se=class r{durableExecutionClient;InitialExecutionState;DurableExecutionArn;CheckpointToken;constructor(e,t){this.durableExecutionClient=t,this.InitialExecutionState=e.InitialExecutionState,this.DurableExecutionArn=e.DurableExecutionArn,this.CheckpointToken=e.CheckpointToken}static isInstance(e){return e instanceof r?!0:!!(typeof e=="object"&&e&&e.toString()==="[object DurableExecutionInvocationInputWithClient]"&&"durableExecutionClient"in e&&e.constructor.name==="DurableExecutionInvocationInputWithClient")}get[Symbol.toStringTag](){return"DurableExecutionInvocationInputWithClient"}},At=async(r,e,t)=>{h("\u{1F535}","Initializing durable function with event:",r),h("\u{1F4CD}","Function Input:",r);let n=r.CheckpointToken,a=r.DurableExecutionArn,i=Se.isInstance(r)?r.durableExecutionClient:new De(t),o=ye({durableExecutionArn:a,requestId:e.awsRequestId,tenantId:e.tenantId}),l=[...r.InitialExecutionState.Operations||[]],u=r.InitialExecutionState.NextMarker;for(;u;){let d=await i.getExecutionState({CheckpointToken:n,Marker:u,DurableExecutionArn:a,MaxItems:1e3},o);l.push(...d.Operations||[]),u=d.NextMarker||""}let c=l.length>1?I.ReplayMode:I.ExecutionMode;h("\u{1F4DD}","Operations:",l);let E=l.reduce((d,s)=>(s.Id&&(d[s.Id]=s),d),{});return h("\u{1F4DD}","Loaded step data:",E),{executionContext:{durableExecutionClient:i,_stepData:E,terminationManager:new Ce,durableExecutionArn:a,pendingCompletions:new Set,getStepData(d){return Dt(E,d)},tenantId:e.tenantId,requestId:e.awsRequestId},durableExecutionMode:c,checkpointToken:n}},Re=6*1024*1024-50;async function bt(r,e,t,n,a,i){let o=new we.EventEmitter,l=new ge(t.durableExecutionArn,t._stepData,t.durableExecutionClient,t.terminationManager,a,o,ye(t),new Set);t.terminationManager.setCheckpointTerminatingCallback(()=>{l.setTerminating()});let u={checkpointManager:l,stepDataEmitter:o,setTerminating:()=>l.setTerminating()},c=Oe(t,e,n,ye(),void 0,u),E=r.InitialExecutionState.Operations?.[0],d=JSON.parse(E?.ExecutionDetails?.InputPayload??"{}");try{h("\u{1F3AF}",`Starting handler execution, handler event: ${d}`);let s=!1,f=!1,g=Y("root",void 0,()=>i(d,c)).then(w=>(s=!0,h("\u{1F3C6}","Handler promise resolved first!"),["handler",w])),p=t.terminationManager.getTerminationPromise().then(w=>(f=!0,h("\u{1F4A5}","Termination promise resolved first!"),u.setTerminating(),["termination",w]));setTimeout(()=>{h("\u23F1\uFE0F","Promise race status check:",{handlerResolved:s,terminationResolved:f})},500);let[C,b]=await Promise.race([g,p]);h("\u{1F3C1}","Promise race completed with:",{resultType:C});try{await u.checkpointManager.waitForQueueCompletion(),h("\u2705","All pending checkpoints completed")}catch(w){h("\u26A0\uFE0F","Error waiting for checkpoint completion:",w)}if(C==="termination"&&b.reason===R.CHECKPOINT_FAILED)throw h("\u{1F6D1}","Checkpoint failed - handling termination"),b.error;if(C==="termination"&&b.reason===R.SERDES_FAILED)throw h("\u{1F6D1}","Serdes failed - terminating Lambda execution"),new de(b.message);if(C==="termination"&&b.reason===R.CONTEXT_VALIDATION_ERROR)return h("\u{1F6D1}","Context validation error - returning FAILED status"),{Status:H.FAILED,Error:P(b.error||new Error(b.message))};if(C==="termination")return h("\u{1F6D1}","Returning termination response"),{Status:H.PENDING};h("\u2705","Returning normal completion response");let y=JSON.stringify(b),T=new TextEncoder().encode(y).length;if(y&&T>Re){h("\u{1F4E6}",`Response size (${T} bytes) exceeds Lambda limit (${Re} bytes). Checkpointing result.`);let w=`execution-result-${Date.now()}`;try{await u.checkpointManager.checkpoint(w,{Id:w,Action:"SUCCEED",Type:m.OperationType.EXECUTION,Payload:y}),h("\u2705","Large result successfully checkpointed");try{await u.checkpointManager.waitForQueueCompletion()}catch(A){h("\u26A0\uFE0F","Error waiting for checkpoint queue completion:",A)}return{Status:H.SUCCEEDED,Result:""}}catch(A){throw h("\u274C","Failed to checkpoint large result:",A),A}}try{await u.checkpointManager.waitForQueueCompletion()}catch(w){h("\u26A0\uFE0F","Error waiting for checkpoint queue completion:",w)}return{Status:H.SUCCEEDED,Result:y}}catch(s){if(h("\u274C","Handler threw an error:",s),Je(s))throw h("\u{1F6D1}","Unrecoverable invocation error - terminating Lambda execution"),s;try{await u.checkpointManager.waitForQueueCompletion()}catch(f){h("\u26A0\uFE0F","Error waiting for checkpoint queue completion:",f)}return{Status:H.FAILED,Error:P(s)}}}function xt(r){try{let e=r;if(!e?.DurableExecutionArn||!e?.CheckpointToken)throw new Error("Missing required durable execution fields")}catch{let e=`Unexpected payload provided to start the durable execution. 
Check your resource configurations to confirm the durability is set.`;throw new Error(e)}}var Fe=(r,e)=>async(t,n)=>{xt(t);let{executionContext:a,durableExecutionMode:i,checkpointToken:o}=await At(t,n,e?.client),l=null;try{return l=await bt(t,n,a,i,o,r),l}catch(u){throw u}},Pt={maxAttempts:60,initialDelay:{seconds:5},maxDelay:{seconds:300},backoffRate:1.5,jitter:v.FULL,timeoutSeconds:void 0};var It=Fe(async(r,e)=>{console.log("durable-handler event",r);let{email:t}=r;return{success:!0,externalResult:await e.waitForCallback("wait-for-external-api",async(a,i)=>{i.logger?.info(`Submitting callback ID to external service: ${a}`);let o=await be({email:t,taskToken:a});console.log("durable-handler result",o)},{timeout:{minutes:15},heartbeatTimeout:{minutes:1}})}});0&&(module.exports={handler});

import{DynamoDBClient as l,GetItemCommand as m,DeleteItemCommand as u}from"@aws-sdk/client-dynamodb";import{LambdaClient as b}from"@aws-sdk/client-lambda";import{SFNClient as f,SendTaskFailureCommand as k,SendTaskSuccessCommand as y}from"@aws-sdk/client-sfn";var r=new f({}),c=new l({}),T=async e=>{console.log(e);let s=typeof e.body=="string"?JSON.parse(e.body):e.body,{email:i,token:o,code:n}=s;if(!o||!n)return{statusCode:400,body:JSON.stringify({error:"token and code required"})};let d=await c.send(new m({TableName:process.env.TABLE_NAME,Key:{id:{S:i},sort:{S:n}}}));if(console.log("taskToken GetItemCommand",d),d.Item?.sort?.S!==n)return e.body.durable||await r.send(new k({taskToken:o,cause:"Invalid verification code"})),{statusCode:400,body:JSON.stringify({error:"Invalid verification code"})};if(s.durable){console.log("Is a durable handler invocation");let t=new b,a=new(await import("@aws-sdk/client-lambda")).SendDurableExecutionCallbackSuccessCommand({CallbackId:o,Result:JSON.stringify({verification:"ok"})});await t.send(a)}else{let t=new y({taskToken:o,output:JSON.stringify({verification:"ok"})}),a=await r.send(t);console.log("taskToken result",a)}return await c.send(new u({TableName:process.env.TABLE_NAME,Key:{id:{S:i}}})),{statusCode:200,body:JSON.stringify({message:"Verification accepted"})}};export{T as handler};

import{DynamoDBClient as c,GetItemCommand as u,UpdateItemCommand as m}from"@aws-sdk/client-dynamodb";var r=new c({}),d=900,a=async(t,e,n=d)=>{let s=Date.now();for(;Date.now()-s<n*1e3;){let o=await r.send(new u({TableName:process.env.TABLE_NAME,Key:{id:{S:t},sort:{S:"0"}}}));if(o.Item&&o.Item.signal?.S)return{received:!0,value:JSON.parse(o.Item.signal.S)};await new Promise(l=>setTimeout(l,2e3))}return{received:!1}};var i=async(t,e)=>{await r.send(new m({TableName:process.env.TABLE_NAME,Key:{email:{S:t},code:{N:"0"}},UpdateExpression:"SET taskToken = :token",ExpressionAttributeValues:{":token":{S:e}}}))};var k=async t=>{console.log("Wait for signal handler triggered:",JSON.stringify(t,null,2));let{requestId:e,taskToken:n}=t;if(!e||!n)throw new Error("Missing requestId or taskToken");await i(e,n);let s=await a(e,n,900);if(s.received)return{statusCode:200,requestId:e,signalReceived:!0,result:s.value};throw new Error("Signal timeout - no signal received within 15 minutes")};export{k as handler};

import{SESClient as l,SendEmailCommand as c}from"@aws-sdk/client-ses";import{DynamoDBClient as u,PutItemCommand as S}from"@aws-sdk/client-dynamodb";var E=new l({}),p=new u({}),i=async s=>{let{to:e,subject:n,body:t,requestId:m}=s;if(!e||!n||!t)throw new Error("Missing required fields: to, subject, body");let r=new Date().toISOString(),a=m||`email-${Date.now()}`;await p.send(new S({TableName:process.env.TABLE_NAME,Item:{id:{S:a},sort:{S:Date.now().toString()},to:{S:e},subject:{S:n},body:{S:t},status:{S:"sent"},timestamp:{S:r}}}));let d=new c({Source:process.env.SENDER_EMAIL,Destination:{ToAddresses:[e]},Message:{Subject:{Data:n},Body:{Text:{Data:t},Html:{Data:t.replace(/\n/g,"<br>")}}}});try{let o=await E.send(d);return{requestId:a,messageId:o.MessageId,timestamp:r,status:"sent"}}catch(o){throw new Error(`Failed to send email to ${e}: ${o instanceof Error?o.message:"Unknown error"}`)}};var b=async s=>{console.log("Step Functions send-email handler:",JSON.stringify(s,null,2));try{let{taskToken:e,...n}=s,t=await i(n);return{statusCode:200,body:JSON.stringify(t)}}catch(e){return console.error("Error in step-functions send-email:",e),{statusCode:500,body:JSON.stringify({error:"Failed to send email",details:e instanceof Error?e.message:"Unknown error"})}}};export{b as handler};

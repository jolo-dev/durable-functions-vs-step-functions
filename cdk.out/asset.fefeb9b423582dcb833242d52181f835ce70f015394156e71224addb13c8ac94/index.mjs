import{SESClient as w,SendEmailCommand as S}from"@aws-sdk/client-ses";import{DynamoDBClient as g,PutItemCommand as E}from"@aws-sdk/client-dynamodb";var k=new w({}),T=new g({}),r=async n=>{let{to:e,subject:t,body:s,requestId:o}=n;if(!e||!t||!s)throw new Error("Missing required fields: to, subject, body");let a=new Date().toISOString(),l=o||`email-${Date.now()}`;await T.send(new E({TableName:process.env.TABLE_NAME,Item:{id:{S:e},sort:{S:Date.now().toString()},to:{S:e},subject:{S:t},body:{S:s},status:{S:"sent"},timestamp:{S:a}}}));let d=new S({Source:process.env.SENDER_EMAIL,Destination:{ToAddresses:[e]},Message:{Subject:{Data:t},Body:{Text:{Data:s},Html:{Data:s.replace(/\n/g,"<br>")}}}}),p=await k.send(d);return{requestId:l,messageId:p.MessageId,timestamp:a,status:"sent"}};import{DynamoDBClient as y,GetItemCommand as I,UpdateItemCommand as f}from"@aws-sdk/client-dynamodb";var m=new y({}),c=async n=>{let e=await m.send(new I({TableName:process.env.TABLE_NAME,Key:{id:{S:n},sort:{N:0}}}));if(!e.Item)throw new Error(`Request ${n} not found`);let t=e.Item,s=t.status?.S||"unknown",o=t.timestamp?.S||"",a=s==="success";return await m.send(new f({TableName:process.env.TABLE_NAME,Key:{id:{S:n},sort:{N:0}},UpdateExpression:"SET #status = :status, #checked = :checked, #result = :result",ExpressionAttributeNames:{"#status":"status"},ExpressionAttributeValues:{":status":{S:a?"success":"incorrect"},":checked":{S:new Date().toISOString()},":result":{S:a.toString()}}})),{requestId:n,status:s,timestamp:o,isCorrect:a,checkResult:a?"success":"incorrect",checkedAt:new Date().toISOString()}};import{DynamoDBClient as C,GetItemCommand as b,UpdateItemCommand as M}from"@aws-sdk/client-dynamodb";var h=new C({}),A=900,u=async(n,e,t=A)=>{let s=Date.now();for(;Date.now()-s<t*1e3;){let o=await h.send(new b({TableName:process.env.TABLE_NAME,Key:{email:{S:n},code:{N:"0"}}}));if(o.Item&&o.Item.signal?.S)return{received:!0,value:JSON.parse(o.Item.signal.S)};await new Promise(a=>setTimeout(a,2e3))}return{received:!1}};var i=class{steps=new Map;stepCounter=0;async step(e,t){this.stepCounter++,console.log(`Executing step ${this.stepCounter}: ${e}`);let s=await t();return this.steps.set(e,s),s}async wait_for_signal(e,t){console.log(`Waiting for signal: ${e}, timeout: ${t.timeout.seconds}s`);let s=this.steps.get("sendEmail");return await u(s?.requestId||"")}async send_task_success(e,t){console.log(`Task success for token: ${e}`,t)}},L=async n=>{console.log("Durable orchestrator triggered:",JSON.stringify(n,null,2));let e=new i,t=await e.step("sendEmail",async()=>await r(n)),s=await e.wait_for_signal("waitForSignal",{timeout:{seconds:300}}),o=await e.step("checkValue",async()=>await c(t.requestId));return{requestId:n.requestId||t.requestId,emailResult:t,signalResult:s,validationResult:o,executionComplete:!0}};export{L as handler};

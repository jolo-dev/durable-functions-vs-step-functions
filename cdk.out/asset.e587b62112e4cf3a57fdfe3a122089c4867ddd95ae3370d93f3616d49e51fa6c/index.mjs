import{SESClient as w,SendEmailCommand as S}from"@aws-sdk/client-ses";import{DynamoDBClient as g,PutItemCommand as E}from"@aws-sdk/client-dynamodb";var y=new w({}),I=new g({}),m=async n=>{let{to:e,subject:t,body:s,requestId:o}=n;if(!e||!t||!s)throw new Error("Missing required fields: to, subject, body");let a=new Date().toISOString(),r=o||`email-${Date.now()}`;await I.send(new E({TableName:process.env.TABLE_NAME,Item:{id:{S:r},to:{S:e},subject:{S:t},body:{S:s},status:{S:"sent"},timestamp:{S:a}}}));let d=new S({Source:process.env.SENDER_EMAIL,Destination:{ToAddresses:[e]},Message:{Subject:{Data:t},Body:{Text:{Data:s},Html:{Data:s.replace(/\n/g,"<br>")}}}}),p=await y.send(d);return{requestId:r,messageId:p.MessageId,timestamp:a,status:"sent"}};import{DynamoDBClient as k,GetItemCommand as T,UpdateItemCommand as f}from"@aws-sdk/client-dynamodb";var c=new k({}),l=async n=>{let e=await c.send(new T({TableName:process.env.TABLE_NAME,Key:{id:{S:n}}}));if(!e.Item)throw new Error(`Request ${n} not found`);let t=e.Item,s=t.status?.S||"unknown",o=t.timestamp?.S||"",a=s==="sent";return await c.send(new f({TableName:process.env.TABLE_NAME,Key:{id:{S:n}},UpdateExpression:"SET #status = :status, checked = :checked, checkResult = :result",ExpressionAttributeNames:{"#status":"status"},ExpressionAttributeValues:{":status":{S:a?"success":"incorrect"},":checked":{S:new Date().toISOString()},":result":{S:a.toString()}}})),{requestId:n,status:s,timestamp:o,isCorrect:a,checkResult:a?"success":"incorrect",checkedAt:new Date().toISOString()}};import{DynamoDBClient as C,GetItemCommand as h,UpdateItemCommand as q}from"@aws-sdk/client-dynamodb";var b=new C({}),A=300,u=async(n,e)=>{let t=Date.now();for(;Date.now()-t<A*1e3;){let s=await b.send(new h({TableName:process.env.TABLE_NAME,Key:{id:{S:n}}}));if(s.Item&&s.Item.signal?.S)return{received:!0,value:JSON.parse(s.Item.signal.S)};await new Promise(o=>setTimeout(o,2e3))}return{received:!1}};var i=class{steps=new Map;stepCounter=0;async step(e,t){this.stepCounter++,console.log(`Executing step ${this.stepCounter}: ${e}`);let s=await t();return this.steps.set(e,s),s}async wait_for_signal(e,t){return console.log(`Waiting for signal: ${e}, timeout: ${t.timeout.seconds}s`),await u(this.steps.get("sendEmail")?.requestId||"")}async send_task_success(e,t){console.log(`Task success for token: ${e}`,t)}},L=async n=>{console.log("Durable orchestrator triggered:",JSON.stringify(n,null,2));let e=new i,t=await e.step("sendEmail",async()=>await m(n)),s=await e.wait_for_signal("waitForSignal",{timeout:{seconds:300}}),o=await e.step("checkValue",async()=>await l(t.requestId));return{requestId:n.requestId||t.requestId,emailResult:t,signalResult:s,validationResult:o,executionComplete:!0}};export{L as handler};
